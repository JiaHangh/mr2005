# 一，环境搭建

### 系统架构

后台管理系统+前台门户系统

分布式结构+微服务

### 项目结构

- mingrui-shop-parent
  - mingrui-shop-basics
    - mingrui-shop-basic-eurka-server
    - mingrui-shop-basic-upload-server
    - mingrui-shop-basic-zuul-server
  - mingrui-shop-commons
    - mingrui-shop-commom-core
  - mingrui-shop-services
    - mingrui-shop-service-xxx
  - mingrui-shop-services-api
    - mingrui-shop-service-api-xxx

### 项目搭建

### 技术选型

#### 前端:

html/css/JavaScript

jQuery

#### 后端:

Mybatis/Spring/springMVC

spring Boot

spring Cloud

#### 开发环境

jdk1.8

#### 域名

一级域名:www.mrshop.com

二级域名:manage.mrshop.com;api.mrshop.com

### 创建项目

#### 创建父工程 

mingrui-shop-parent,删除src文件夹,配置pom文件引入依赖

```java
<properties> <!--项目构建编码-->
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    <project.reporting.outputEncoding>UTF- 8</project.reporting.outputEncoding> <!--声明JDK版本-->
    <java.version>1.8</java.version> <!--spring cloud 版本.注意此版本是建立在boot2.2.2版本上的-->
    <mr.spring.cloud.version>Hoxton.SR1</mr.spring.cloud.version>
</properties>

<!--boot 版本-->
<parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-parent</artifactId>
    <version>2.3.1.RELEASE</version> <!--始终从仓库中获取，不从本地路径获取-->
    <relativePath/>
</parent>
<dependencies>
    <!-- 集成commons工具类 -->
    <dependency>
        <groupId>org.apache.commons</groupId>
        <artifactId>commons-lang3</artifactId>
    </dependency>
    <!-- 集成lombok 框架 -->
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
    </dependency> 
    <!--junit测试-->
    <dependency>
        <groupId>junit</groupId>
        <artifactId>junit</artifactId>
    </dependency> 
    <!-- SpringBoot整合eureka客户端 -->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
    </dependency> 
    <!--boot 测试模块-->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-test</artifactId>
        <scope>test</scope>
    </dependency>
</dependencies>

<!-- 项目依赖,子级模块可以继承依赖-->
<dependencyManagement>
    <dependencies> <!--cloud 依赖-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-dependencies</artifactId>
            <version>${mr.spring.cloud.version}</version>
            <type>pom</type> <!--解决maven单继承的问题-->
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>

<!-- 注意： 这里必须要添加， 否者各种依赖有问题 -->
<repositories>
    <repository>
        <id>spring-milestones</id>
        <name>Spring Milestones</name>
        <url>https://repo.spring.io/libs-milestone</url>
        <snapshots>
            <enabled>false</enabled>
        </snapshots>
    </repository>
</repositories>
```

### 创建基础服务父工程 

mingrui-shop-basics,删除src文件,将pom文件里的打包方式设置为pom,暂时不引入依赖

### 创建公共工程

mingrui-shop-commoms,删除src文件夹,将pom文件里的打包方式设置为pom,暂时不引入依赖

### 创建服务实现工程

mingrui-shop-service,删除src文件夹,配置pom文件引入依赖

```java
<!-- SpringBoot-整合Web组件 -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency> 
<!-- springcloud feign组件 -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```

### 创建服务接口工程

mingrui-shop-service-api,删除src文件夹,配置pom文件引入依赖

```
<!-- SpringBoot-整合Web组件 -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>
```

### 创建eureka服务

在mingrui-shop-basics下创建mingrui-shop-basic-eureka-server,配置pom文件引入依赖

```java
<!--eureka 服务依赖-->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
    </dependency>
```

配置文件application.yml

```
server:
  port: 8761
spring:
  application:
    name: eureka-server
eureka:
  client:
    # eureka服务url,值为map集合默认key为defaultZone
    service-url:
      defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka
    # 当前服务是否同时注册
    register-with-eureka: false
    # 去注册中心获取其他服务的地址
    fetch-registry: false
  instance:
    hostname: localhost
    # 定义服务续约任务（心跳）的调用间隔，单位：秒 默认30
    lease-renewal-interval-in-seconds: 1
    # 定义服务失效的时间，单位：秒 默认90
    lease-expiration-duration-in-seconds: 2
  server:
    # 测试时关闭自我保护机制，保证不可用服务及时踢出
    enable-self-preservation: false
```

启动类RunEurekaServerApplication

```java
@SpringBootApplication
@EnableEurekaServer
public class RunEurekaServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(RunEurekaServerApplication.class);
    }
}
```



# 二，商品分类管理



### 查询

#### 在mingrui-shop-service-api-xxx中的com.baidu.shop.entity包下新建实体类 CategoryEntity	sS

```java
package com.baidu.shop.entity;
import com.baidu.shop.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;
import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;

/**
 * @ClassName CategoryEntity
 * @Description: TODO
 * @Author jiahang
 * @Date 2020/12/22
 * @Version V1.0
 **/
@ApiModel(value="分类实体类")
@Data
@Table(name="tb_category")
public class CategoryEntity {
    @Id
    @ApiModelProperty(value="类目id",example = "1")
    @NotNull(message = "id不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "类目名称")
    @NotEmpty(message = "分类名称不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private String name;

    @ApiModelProperty(value = "父类目id,顶级类目填0",example = "1")
    @NotNull(message = "父类id不能为空",groups = {MingruiOperation.Add.class})
    private Integer parentId;

    @ApiModelProperty(value = "是否为父节点，0为否，1为是",example = "1")
    @NotNull(message = "节点状态不能为空",groups = {MingruiOperation.Add.class})
    private Integer isParent;

    @ApiModelProperty(value="排序指数，越小越靠前",example = "1")
    @NotNull(message = "排序指数不能为空",groups = {MingruiOperation.Add.class})
    private Integer sort;
}

```

#### 	在service下定义商品分类接口CategoryService

```java
package com.baidu.shop.service;

import com.baidu.shop.base.Result;
import com.baidu.shop.entity.CategoryEntity;
import com.baidu.shop.group.MingruiOperation;
import com.google.gson.JsonObject;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@Api(tags = "商品分类接口")
public interface CategoryService {
    @ApiOperation(value="通过查询商品分类")
    @GetMapping(value = "category/list")
    Result<List<CategoryEntity>> getCategoryByPid(Integer pid);

}

```

#### 在mingrui-shop-service-xxx中的shop.service.impl下新建实体类CategoryServiceImpl

##### CategoryServiceImpl实体类需要实现CategoryService接口,同时还需要继承工具类BaseApiService,重写接口中的查询方法

```java
 @Override
    public Result<List<CategoryEntity>> getCategoryByPid(Integer pid) {
        CategoryEntity categoryEntity = new CategoryEntity();
        categoryEntity.setParentId(pid);
        List<CategoryEntity>list = categoryMapper.select(categoryEntity);
        return this.setResultSuccess(list);
    }
```

#### 在mingrui-shop-service-xxx中的shop.mapper下新建接口CategoryMapper

```java
package com.baidu.shop.mapper;


import com.baidu.shop.entity.CategoryEntity;
import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.common.Mapper;

import java.util.List;

public interface CategoryMapper extends Mapper<CategoryEntity> {
    //该SQL用来通过品牌id查询绑定分类属性
    @Select(value = "select id,name from tb_category where id in (select category_id from tb_category_brand where brand_id=#{brandId})")
    List<CategoryEntity> getCategoryByBrandId(Integer brandId);
}

```



### 新增

#### 在CategoryService接口中添加新增方法

```java
@ApiOperation(value = "新增")
    @PostMapping(value="category/save")
    Result<JsonObject>saveCategory(@Validated({MingruiOperation.Add.class})@RequestBody  CategoryEntity entity);
```

#### 直接在CategoryService中重写新增方法

```java
@Transactional
    @Override
    public Result<JsonObject> saveCategory(CategoryEntity categoryEntity) {
        CategoryEntity saveCategoryEntity = new CategoryEntity();
        saveCategoryEntity.setId(categoryEntity.getParentId());
        saveCategoryEntity.setIsParent(1);
        categoryMapper.updateByPrimaryKeySelective(saveCategoryEntity);
        categoryMapper.insertSelective(categoryEntity);
        return this.setResultSuccess();
    }
Category查询出来是树状图的,有父子叶结构,要在某个节点下添加一个子节点,那么改节点必须是父节点状态,如果在子节点下添加新的节点,那么就将当前子节点的状态改为父节点

```

### 修改

#### 修改没有太多需要注意的地方 直接在CategoryService接口中添加修改方法

```java
@ApiOperation(value="修改分类")
    @PutMapping(value="category/update")
    Result<JsonObject>updateCategory(@Validated({MingruiOperation.Update.class}) @RequestBody  CategoryEntity entity);
```

#### 在CategoryService中重写修改方法

```java
@Transactional
    @Override
    public Result<JsonObject> updateCategory(CategoryEntity entity) {
        categoryMapper.updateByPrimaryKeySelective(entity);
        return this.setResultSuccess();
    }
```

### 删除

#### CategoryService接口中添加删除方法

```java
@ApiOperation(value="通过id删除分类")
    @DeleteMapping(value="category/del")
    Result<JsonObject>delCategory(Integer id);
```

#### 在mingrui-shop-common-core下新建工具类ObjectUtil

```java
package com.baidu.shop.utils;

/**
 * @ClassName ObjectUtil
 * @Description: TODO
 * @Author jiahang
 * @Date 2020/12/23
 * @Version V1.0
 **/
public class ObjectUtil {
    public static  boolean isNull(Object obj){
        return obj ==null;
    }
    public static  boolean isNotNull(Object obj){
        return obj !=null;
    }
}

```

#### 在CategoryService中重写修改方法

```java
@Transactional
    @Override
    public Result<JsonObject> delCategory(Integer id) {
        //检验id是否合法
        if(ObjectUtil.isNull(id) || id<=0) return this.setResultError("id不合法");
        CategoryEntity categoryEntity = categoryMapper.selectByPrimaryKey(id);
        //判断id是否存在
        if(ObjectUtil.isNull(categoryEntity))return this.setResultError("数据不存在");
        //判断当前节点是否为父节点(isParent为1)
        if(categoryEntity.getIsParent()==1)return this.setResultError("当前节点为父节点");
		//品牌管理中绑定有分类标签,在删除标签需要判断该分类是否绑定在品牌中
        Example example1 = new Example(CategoryBrandEntity.class);
        example1.createCriteria().andEqualTo("categoryId",id);
        List<CategoryBrandEntity> categoryBrandEntities = categoryBrandMapper.selectByExample(example1);
        if(categoryBrandEntities.size() != 0){
            return this.setResultError("该属性已被品牌绑定不能删除");
        }


        //通过当前节点的父节点id查询当前节点的父节点下是否还有其他子节点;
        Example example = new Example(CategoryEntity.class);
        //前边格式固定 拼接sql语句   where 1 = 1; select form 表明 where 1=1 and parentId=?
        example.createCriteria().andEqualTo("parentId", categoryEntity.getParentId());
        //将拼接后的sql返回到list集合内
        List<CategoryEntity> categoryEntities = categoryMapper.selectByExample(example);



        //如果size<=1,如果当前节点被删除的话,当前节点父节点下就没有其他节点,将父节点的状态改为0
        if(categoryEntities.size()<=1){
            CategoryEntity updateCategoryEntity = new CategoryEntity();
            updateCategoryEntity.setParentId(0);
            updateCategoryEntity.setId(categoryEntity.getParentId());

            categoryMapper.updateByPrimaryKeySelective(updateCategoryEntity);

        }
        //通过id删除节点
        categoryMapper.deleteByPrimaryKey(id);
        return this.setResultSuccess();
    }
```



# 三，品牌管理

### 1品牌管理（查询）

#### 1.1 vue项目

##### 1.1.1 官网地址: 表格:https://v15.vuetifyjs.com/zh-Hans/components/data-tables 

##### 输入框:https://v15.vuetifyjs.com/zh-Hans/components/snackbars 

##### 按钮:https://v15.vuetifyjs.com/zh-Hans/components/buttons

##### 1.2 在item包下新建MrBrand.vue

```js
<template>
  <v-card>
    <v-card-title>
      <v-btn @click="addBrand" color="primary">新增品牌</v-btn>
      <v-spacer/>
      <v-text-field
        append-icon="search"
        label="搜索"
        single-line
        hide-details
        v-model="search"
      />
    </v-card-title>
    <v-divider/>
    <v-data-table
      :headers="headers"
      :items="items"
      :pagination.sync="pagination"
      :total-items="totalItems"
      :loading="loading"
      class="elevation-1"
    >
      <template slot="items" slot-scope="props">
        <td class="text-xs-center">{{ props.item.id }}</td>
        <td class="text-xs-center">{{ props.item.name }}</td>
        <td class="text-xs-center"><img v-if="!!props.item.image" width="102" height="36" :src="props.item.image"/></td>
        <td class="text-xs-center">{{ props.item.letter }}</td>
        <td class="justify-center layout px-0">
          <v-btn icon @click="editBrand(props.item)">
            <i class="el-icon-edit"/>
          </v-btn>
          <v-btn icon @click="deleteBrand(props.item)">
            <i class="el-icon-delete"/>
          </v-btn>
        </td>
      </template>
      <template slot="expand" slot-scope="props">
        <v-card flat>
          <v-card-text>Peek-a-boo!</v-card-text>
        </v-card>
      </template>
      <template slot="no-data">
        <v-alert :value="true" color="error" icon="warning">
          对不起，没有查询到任何数据 :(
        </v-alert>
      </template>
      <template slot="pageText" slot-scope="props">
        共{{props.itemsLength}}条,当前:{{ props.pageStart }} - {{ props.pageStop }}
      </template>
    </v-data-table>

    <v-dialog v-model="show" max-width="600" scrollable v-if="show">
      <v-card>
        <v-toolbar dark dense color="primary">
          <v-toolbar-title>{{isEdit ? '修改品牌' : '新增品牌'}}</v-toolbar-title>
          <v-spacer/>
          <v-btn icon @click="show = false">
            <v-icon>close</v-icon>
          </v-btn>
        </v-toolbar>
        <v-card-text class="px-5 py-2">
          <!-- 表单 -->
          <brand-form :oldBrand="brand" :isEdit="isEdit" @close="show = false" :reload="getDataFromApi"/>
        </v-card-text>
      </v-card>
    </v-dialog>
  </v-card>

</template>

<script>
  import BrandForm from './BrandForm'
  import {brandData} from '../../mockDB'

  export default {
    name: "brand",
    components: {
      BrandForm
    },
    data() {
      return {
        search: '',// 过滤字段
        totalItems: 0,// 总条数
        items: [],// 表格数据
        loading: true,
        pagination: {},// 分页信息
        headers: [// 表头
          {text: 'id', align: 'center', value: 'id'},
          {text: '名称', align: 'center', sortable: false, value: 'name'},
          {text: 'LOGO', align: 'center', sortable: false, value: 'image'},
          {text: '首字母', align: 'center', value: 'letter', sortable: true,},
          {text: '操作', align: 'center', value: 'id', sortable: false}
        ],
        show: false,// 是否弹出窗口
        brand: {}, // 品牌信息
        isEdit: false // 判断是编辑还是新增
      }
    },
    watch: {
      pagination: {
        handler() {
          this.getDataFromApi();
        },
        deep: true
      },
      search: {
        handler() {
          this.getDataFromApi();
        }
      },
      show(val, oldVal) {
        // 表单关闭后重新加载数据
        if (oldVal) {
          this.getDataFromApi();
        }
      }
    },
    mounted() {
      this.getDataFromApi();
    },
    methods: {
      addBrand() {
        this.brand = {};
        this.isEdit = false;
        this.show = true;
      },
      editBrand(item) {
        this.brand = item;
        this.isEdit = true;
        this.show = true;
        // 查询商品分类信息，进行回显
        this.$http.get("/item/category/bid/" + item.id)
          .then(resp => {
            this.brand.categories = resp.data;
          })

      },
      deleteBrand(item) {
        this.$message.confirm('此操作将永久删除该品牌, 是否继续?').then(() => {
          // 发起删除请求
          this.$http.delete("/item/brand?id=" + item.id,)
            .then(() => {
              // 删除成功，重新加载数据
              this.$message.success("删除成功！");
              this.getDataFromApi();
            })
        }).catch(() => {
          this.$message.info("删除已取消！");
        });

      },
      getDataFromApi() {
        this.loading = true;
        // 200ms后返回假数据
        window.setTimeout(() => {
          this.items = brandData.slice(0,4);
          this.totalItems = 100
          this.loading = false;
        }, 200)
      }
    }
  }
</script>

<style scoped>

</style>

```

##### 2.1.3 index.js line : 27

```js
 route("/item/brand",'/item/MrBrand',"MrBrand"),
```

### 2 common-core 

##### 2.1 pom.xml

```java
    <!--帮助开发人员快速生成API文档-->
    <dependency>
        <groupId>io.springfox</groupId>
        <artifactId>springfox-swagger2</artifactId>
        <version>2.9.2</version>
    </dependency>

```

2.2 在base包下新建BaseDTO

```java
package com.baidu.shop.base;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;
import org.apache.commons.lang.StringUtils;

/**
 * 2 * @ClassName BaseDTO
 * 3 * @Description: TODO
 * 4 * @Author jiahang
 * 5 * @Date 2020/12/25
 * 6 * @Version V1.0
 * 7
 **/
@Data
@ApiModel(value = "BaseDTO用于数据传输,其他dto需要继承此类")
public class BaseDTO {

    @ApiModelProperty(value = "当前页",example = "1")
    private Integer page;

    @ApiModelProperty(value = "每页条数",example = "5")
    private Integer rows;

    @ApiModelProperty(value = "排序字段")
    private String sort;

    @ApiModelProperty(value = "是否升序")
    private String order;

    public String getOrderBy(){
        return sort + " " + (Boolean.valueOf(order)?"desc":"asc");
    }

}
```

#### 2.3 mingrui-shop-api 

##### 2.3.1 pom.xml

```java
    <!--分页工具-->
    <dependency>
        <groupId>com.github.pagehelper</groupId>
        <artifactId>pagehelper-spring-boot-starter</artifactId>
        <version>1.2.10</version>
    </dependency>

```

#### 2.4 mingrui-shop-api-xxx 

##### 2.4.1 在com.baidu.shop下新建dto包 

##### 2.4.1.1 BrandDTO

```
package com.baidu.shop.dto;

import com.baidu.shop.base.BaseDTO;
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.persistence.Id;
import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;

/**
 * 2 * @ClassName BrandDTO
 * 3 * @Description: TODO
 * 4 * @Author jiahang
 * 5 * @Date 2020/12/25
 * 6 * @Version V1.0
 * 7
 **/
@ApiModel(value = "品牌DTO")
@Data
public class BrandDTO extends BaseDTO {

    @Id
    @ApiModelProperty(value = "品牌主键",example = "1")
    @NotNull(message = "主键不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "品牌名称")
    @NotEmpty(message = "品牌名称不能为空",groups = {MingruiOperation.Update.class,MingruiOperation.Add.class})
    private String name;

    @ApiModelProperty(value = "品牌logo")
    private String image;

    @ApiModelProperty(value = "品牌首字母")
    private Character letter;

}

```

##### 2.4.2 entity包下新建BrandEntity

```java
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.Table;

/**
 * 2 * @ClassName BrandEntity
 * 3 * @Description: TODO
 * 4 * @Author jiahang
 * 5 * @Date 2020/12/25
 * 6 * @Version V1.0
 * 7
 **/
@Data
@Table(name = "tb_brand")
public class BrandEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)//主键自增
    private Integer id;

    private String name;

    private String image;

    private Character letter;
}

```

##### 2.4.2 service包下新建BrandService

```java
package com.baidu.shop.service;

import com.baidu.shop.base.Result;
import com.baidu.shop.dto.BrandDTO;
import com.baidu.shop.entity.BrandEntity;
import com.baidu.shop.validate.group.MingruiOperation;
import com.github.pagehelper.PageInfo;
import com.google.gson.JsonObject;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

/**
 * 2 * @ClassName BrandService
 * 3 * @Description: TODO
 * 4 * @Author jiahang
 * 5 * @Date 2020/12/25
 * 6 * @Version V1.0
 * 7
 **/
@Api(tags = "品牌接口")//表示标识这个类是swagger的资源
public interface BrandService {
    @ApiOperation(value = "获得品牌信息")
    @GetMapping(value = "/brand/list")
    public Result<PageInfo<BrandEntity>> getBrandInfo(BrandDTO brandDTO);

    //接口的默认修饰符为private
    @ApiOperation(value = "新增品牌")
    @PostMapping(value = "/brand/save")
    Result<JsonObject> save(@Validated({MingruiOperation.Add.class}) @RequestBody BrandDTO brandDTO);

    @ApiOperation(value = "修改品牌信息")
    @PutMapping(value = "/brand/save")
    Result<JsonObject> editBrand(@Validated({MingruiOperation.Update.class}) @RequestBody BrandDTO brandDTO);


    @ApiOperation(value = "删除品牌信息")
    @DeleteMapping(value = "/brand/deleteBrand")
    Result<JsonObject> deleteBrandId(Integer id);
}

```

#### 2.5 mingrui-shop-service-xxx 

##### 2.5.1 在mapper包下新建BrandMapper

```java
import com.baidu.shop.entity.BrandEntity;
import tk.mybatis.mapper.common.Mapper;

public interface BrandMapper extends Mapper<BrandEntity> {
}

```

##### 2.5.2 在impl包下新建BrandServiceImpl

```java
import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.dto.BrandDTO;
import com.baidu.shop.entity.BrandEntity;
import com.baidu.shop.mapper.BrandMapper;
import com.baidu.shop.service.BrandService;
import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import org.springframework.util.StringUtils;
import org.springframework.web.bind.annotation.RestController;
import tk.mybatis.mapper.entity.Example;
import javax.annotation.Resource;
import java.util.List;

/**
 * 2 * @ClassName BrandServiceImpl
 * 3 * @Description: TODO
 * 4 * @Author jiahang
 * 5 * @Date 2020/12/25
 * 6 * @Version V1.0
 * 7
 **/
@RestController
public class BrandServiceImpl extends BaseApiService implements BrandService {

    @Autowired
    private BrandMapper brandMapper;
    
    @Override
    public Result<PageInfo<BrandEntity>> getBrandInfo(BrandDTO brandDTO) {
        //分页
        PageHelper.startPage(brandDTO.getPage(),brandDTO.getRows());

        BrandEntity brandEntity = BaiduBeanUtil.copyProperties(brandDTO, BrandEntity.class);

        Example example=new Example(BrandEntity.class);
        //排序
//        if (!StringUtils.isEmpty(brandDTO.getOrder()))
//            example.setOrderByClause(brandDTO.getOrderByClause());
        if(!StringUtils.isEmpty(brandDTO.getSort())) PageHelper.orderBy(brandDTO.getOrderBy());

        example.createCriteria().andLike("name","%"+brandEntity.getName()+"%");

        //查询
        List<BrandEntity> list = brandMapper.selectByExample(example);

        PageInfo<BrandEntity> pageInfo = new PageInfo<>(list);

        return this.setResultSuccess(pageInfo);
    }
}
```

### 3 品牌管理（新增）

- 模态框地址:https://v15.vuetifyjs.com/zh-Hans/components/dialogs
-  form表单地址:https://v15.vuetifyjs.com/zh-Hans/components/forms

#### 3.1 vue项目 

##### 3.1.1 新建MrBrandForm.vue

```js
<template>
  <v-form v-model="valid" ref="brandForm">
    <v-text-field
      label="品牌名称"
      v-model="brand.name"
      :rules="[v => !!v || '品牌名称不能为空']"
      :counter="10"
      required
    />
    <v-text-field
      label="首字母"
      v-model="brand.letter"
      :rules="[v => v.length === 1 || '首字母只能是1位']"
      required
      mask="A"
    />
    <v-cascader url="/item/category/list" required
                v-model="brand.categories"
                multiple label="商品分类"/>
    <v-layout row>
      <v-flex xs3>
        <span style="font-size: 16px; color: #444">品牌LOGO：</span>
      </v-flex>
      <v-flex>
        <v-upload
          v-model="brand.image" url="/item/upload" :multiple="false" :pic-width="250" :pic-height="90"
        />
      </v-flex>
    </v-layout>
    <v-layout class="my-4">
      <v-btn @click="submit" color="primary">提交</v-btn>
      <v-btn @click="clear" color="warning">重置</v-btn>
    </v-layout>
  </v-form>
</template>

<script>
  import config from '@/config';
  export default {
    name: "brand-form",
    props: {
      oldBrand: Object,
      isEdit: {
        type: Boolean,
        default: false
      },
      show: {
        type: Boolean,
        default: true
      }
    },
    data() {
      return {
        baseUrl: config.api,
        valid:false,
        brand: {
          name: "",
          image: "",
          letter: "",
          categories: []
        },
        imageDialogVisible:false
      }
    },
    watch: {
      oldBrand:{
        deep:true,
        handler(val){
          Object.deepCopy(val,this.brand);
        }
      }
    },
    methods: {
      submit() {
        // 表单校验
        if (this.$refs.brandForm.validate()) {
          this.brand.categories = this.brand.categories.map(c => c.id);
          this.brand.letter = this.brand.letter.toUpperCase();
          // 将数据提交到后台
          this.$http({
            method: this.isEdit ? 'put' : 'post',
            url: '/item/brand',
            data: this.$qs.stringify(this.brand)
          }).then(() => {
            // 关闭窗口
            this.$message.success("保存成功！");
            this.closeWindow();
          }).catch(() => {
            this.$message.error("保存失败！");
          });
        }
      },
      clear() {
        // 重置表单
        this.$refs.brandForm.reset();
        this.categories = [];
      },
      // 图片上传出成功后操作
      handleImageSuccess(res) {
        this.brand.image = res;
      },
      removeImage(){
        this.brand.image = "";
      },
      closeWindow(){
        this.$emit("close");
      }
    }
  }
</script>

<style scoped>

</style>

```

##### 3.1.2 Casecader.vue需要修改113行 

```js
	then(resp => {//改
            const data = [];
            for (let d of resp.data.data) {//改,line:113
              const node = {
                value: d[this.itemValue],
                label: d[this.itemText]
              }
              if (d.isParent) {
                node['children'] = [];
                node['loading'] = false;
              }
              data.push(node)
            }
            resolve(data);
          })
```

##### 3.1.3 MrBrand.vue,查询那个vue

#### 3.2 common-core 

##### 3.2.1 在utils包下新建BaiduBeanUtil

```java
package com.baidu.shop.utils;

import org.springframework.beans.BeanUtils;

/**
 * 2 * @ClassName BaiduBeanUtil
 * 3 * @Description: TODO
 * 4 * @Author jiahang
 * 5 * @Date 2020/12/25
 * 6 * @Version V1.0
 * 7
 **/
public class BaiduBeanUtil {
    public static <T> T copyProperties(Object source,Class<T> clazz){

        try {
            T t = clazz.newInstance();//创建当前类型的实例
            BeanUtils.copyProperties(source,t);
            return t;
        } catch (InstantiationException e) {
            e.printStackTrace();
        } catch (IllegalAccessException e) {
            e.printStackTrace();
        }

        return null;
    }
}

```

#### 3.3 mingrui-shop-service-api-xxx 

##### 3.3.1 BrandDTO

```java
	@ApiModelProperty(value = "品牌id集合")
    @NotEmpty(message = "品牌分类信息不能为空",groups = {MingruiOperation.Add.class})
    private String categories;
```



##### 3.3.2 entity包下新建CategoryBrandEntity

```java
package com.baidu.shop.entity;

import io.swagger.annotations.ApiModel;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import javax.persistence.Table;

/**
 * 2 * @ClassName CategoryBrandEntity
 * 3 * @Description: TODO
 * 4 * @Author jiahang
 * 5 * @Date 2020/12/28
 * 6 * @Version V1.0
 * 7
 **/
@Data
@Table(name = "tb_category_brand")
@NoArgsConstructor
@AllArgsConstructor
public class CategoryBrandEntity {
    private Integer categoryId;

    private Integer brandId;
}

```

##### 3.3.3 BrandService,新增的service有

##### 3.4.2 BrandServiceImpl

封装方法

```java
	@Autowired
    private CategoryBrandMapper categoryBrandMapper;

//通过brandId删除中间表的数据
private void deleteCategoryBrandList(Integer id){
    Example example = new Example(CategoryBrandEntity.class);
    example.createCriteria().andEqualTo("brandId",id);
    categoryBrandMapper.deleteByExample(example);
}

private void insertBrandId(String categories,Integer brandId){

    if (StringUtils.isEmpty(categories)) throw new RuntimeException();
    if (categories.contains(",")){
        categoryBrandMapper.insertList(
                Arrays.asList(categories.split(","))
                        .stream()
                        .map(categoryIds->new CategoryBrandEntity(Integer.valueOf(categoryIds),brandId))
                        .collect(Collectors.toList())
        );
    }else{
        CategoryBrandEntity categoryBrandEntity = new CategoryBrandEntity();
        categoryBrandEntity.setCategoryId(Integer.valueOf(categories));
        categoryBrandEntity.setBrandId(brandId);
        categoryBrandMapper.insertSelective(categoryBrandEntity);
    }
}
```

##### 新增impl

```java
 @Override
    public Result<JsonObject> save(BrandDTO brandDTO) {
        //新增返回主键
        //两种方式实现 select-key insert加两个属性

        BrandEntity brandEntity = BaiduBeanUtil.copyProperties(brandDTO, BrandEntity.class);//处理品牌首字母
        brandEntity.setLetter(PinyinUtil.getUpperCase(String.valueOf(brandEntity.getName().toCharArray()[0]),false).toCharArray()[0]);
        brandMapper.insertSelective(brandEntity);

        //维护中间表数据
        //String categories = brandDTO.getCategories();//得到分类集合字符串
        //if (StringUtils.isEmpty(brandDTO.getCategories())) return this.setResultError("新球，错了");
//        ArrayList<CategoryBrandEntity> categoryBrandEntities = new ArrayList<>();

        this.insertBrandId(brandDTO.getCategories(),brandEntity.getId());


        return this.setResultSuccess();
    }
```

##### 4.1.3.1mingrui-shop-service-xxx下创建 CategoryMapper

```java
import com.baidu.shop.entity.CategoryEntity;

import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.common.Mapper;

import java.util.List;


public interface CategoryMapper extends Mapper<CategoryEntity> {

    @Select(value = "SELECT id,name from tb_category where id in (select category_id from tb_category_brand where brand_id=#{brandId})")
    List<CategoryEntity> getCategoryByBrandId(Integer brandId);
}
```

##### 修改impl

```java
@Transactional
@Override
public Result<JsonObject> editBrand(BrandDTO brandDTO) {
    BrandEntity brandEntity = BaiduBeanUtil.copyProperties(brandDTO, BrandEntity.class);
    brandEntity.setLetter(PinyinUtil.getUpperCase(String.valueOf(brandEntity.getName().toCharArray()[0]),false).toCharArray()[0]);
    brandMapper.updateByPrimaryKeySelective(brandEntity);

    //先通过brandId删除中间表的数据
    //封装的方法
    this.deleteCategoryBrandList(brandEntity.getId());

    //批量新增 / 新增
    //String categories = brandDTO.getCategories();//得到分类集合字符串

    this.insertBrandId(brandDTO.getCategories(),brandEntity.getId());

    return this.setResultSuccess();
}
```

##### 删除impl

```java
@Override
public Result<JsonObject> deleteBrandId(Integer id) {
    brandMapper.deleteByPrimaryKey(id);
    //封装方法-----通过brandId删除中间表的数据
    this.deleteCategoryBrandList(id);
    return this.setResultSuccess();
}
```



### 4 品牌首字母自动识别

#### 4.1 common-core 

##### 4.1.2.1 pom.xml

```java
    <dependency>
        <groupId>com.belerweb</groupId>
        <artifactId>pinyin4j</artifactId>
        <version>2.5.1</version>
    </dependency>

```

##### 4.1.2.2 在utils包下新建PinyinUtil

```java
package com.baidu.shop.utils;

import net.sourceforge.pinyin4j.PinyinHelper;
import net.sourceforge.pinyin4j.format.HanyuPinyinOutputFormat;
import net.sourceforge.pinyin4j.format.HanyuPinyinToneType;

import java.util.regex.Matcher;
import java.util.regex.Pattern;

/**
 * 2 * @ClassName PinyinUtil
 * 3 * @Description: TODO
 * 4 * @Author jiahang
 * 5 * @Date 2020/12/28
 * 6 * @Version V1.0
 * 7
 **/
public class PinyinUtil {
    public static final Boolean TO_FUUL_PINYIN = true;
    public static final Boolean TO_FIRST_CHAR_PINYIN = false;
    /**
     * 获取汉字首字母或全拼大写字母
     *
     * @param chinese 汉字
     * @param isFull 是否全拼 true:表示全拼 false表示：首字母
     * @return 全拼或者首字母大写字符窜
     */
    public static String getUpperCase(String chinese, boolean isFull) {
        return convertHanzi2Pinyin(chinese, isFull).toUpperCase();
    }
    /**
     * 获取汉字首字母或全拼小写字母
     *
     * @param chinese 汉字
     * @param isFull 是否全拼 true:表示全拼 false表示：首字母
     * @return 全拼或者首字母小写字符窜
     */
    public static String getLowerCase(String chinese, boolean isFull) {
        return convertHanzi2Pinyin(chinese, isFull).toLowerCase();
    }
    /**
     * 将汉字转成拼音
     * <p>
     * 取首字母或全拼
     *
     * @param hanzi 汉字字符串
     * @param isFull 是否全拼 true:表示全拼 false表示：首字母
     * @return 拼音
     */
    private static String convertHanzi2Pinyin(String hanzi, boolean isFull) {
        /***
         * ^[\u2E80-\u9FFF]+$ 匹配所有东亚区的语言
         * ^[\u4E00-\u9FFF]+$ 匹配简体和繁体
         * ^[\u4E00-\u9FA5]+$ 匹配简体
         */
        String regExp = "^[\u4E00-\u9FFF]+$";
        StringBuffer sb = new StringBuffer();
        if (hanzi == null || "".equals(hanzi.trim())) {
            return "";
        }
        String pinyin = "";
        for (int i = 0; i < hanzi.length(); i++) {
            char unit = hanzi.charAt(i);
//是汉字，则转拼音
            if (match(String.valueOf(unit), regExp)) {
                pinyin = convertSingleHanzi2Pinyin(unit);
                if (isFull) {
                    sb.append(pinyin);
                } else {
                    sb.append(pinyin.charAt(0));
                }
            } else {
                sb.append(unit);
            }
        }
        return sb.toString();
    }
    /**
     * 将单个汉字转成拼音
     *
     * @param hanzi 汉字字符
     * @return 拼音
     */
    private static String convertSingleHanzi2Pinyin(char hanzi) {
        HanyuPinyinOutputFormat outputFormat = new HanyuPinyinOutputFormat();
        outputFormat.setToneType(HanyuPinyinToneType.WITHOUT_TONE);
        String[] res;
        StringBuffer sb = new StringBuffer();
        try {
            res = PinyinHelper.toHanyuPinyinStringArray(hanzi, outputFormat);
            sb.append(res[0]);//对于多音字，只用第一个拼音
        } catch (Exception e) {
            e.printStackTrace();
            return "";
        }
        return sb.toString();
    }
/**
 * 匹配
 * <P>
 * 根据字符和正则表达式进行匹配
 *
 * @param str 源字符串
 *  @param regex 正则表达式
 *
 *  @return true：匹配成功 false：匹配失败
 * */
    private static boolean match(String str, String regex) {
        Pattern pattern = Pattern.compile(regex);
        Matcher matcher = pattern.matcher(str);
        return matcher.find();
    }

}
```

### 5 图片上传

1. ##### vue项目

2. ##### Upload.vue line:88&89

   ```js
   		this.dialogImageUrl = file.response.data;
           this.$emit("input", file.response.data)
   ```

3. ##### MrBrandForm.vue,   在1.2中的vue中

4. ##### 在mingrui-shop-basics下新建mingrui-shop-basic-uploadserver

   1. ###### pom.xml

      ```java
      <dependencies>
          <!-- SpringBoot-整合Web组件 -->
          <dependency>
              <groupId>org.springframework.boot</groupId>
              <artifactId>spring-boot-starter-web</artifactId>
          </dependency>
          <dependency>
              <groupId>com.baidu</groupId>
              <artifactId>mingrui-shopcommon-core</artifactId>
              <version>1.0-SNAPSHOT</version>
          </dependency>
      </dependencies>
      ```

   2. ###### application.yml

      ```java
      server:
        port: 8200
      spring:
        application:
          name: upload-server
      eureka:
        client:
          service-url:
            defaultZone: http://localhost:8761/eureka
      
      mingrui:
        upload:
          path:
            windows: D:\\images
            linux: /jiahang/images
          img:
            host: http://image.mrshop.com
      ```

   3. 启动类

      ```java
      package com.baidu;
      
      import org.springframework.boot.SpringApplication;
      import org.springframework.boot.autoconfigure.SpringBootApplication;
      import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
      
      /**
       * 2 * @ClassName RunUploadServerApplication
       * 3 * @Description: TODO
       * 4 * @Author jiahang
       * 5 * @Date 2020/12/29
       * 6 * @Version V1.0
       * 7
       **/
      @SpringBootApplication
      @EnableEurekaClient
      public class RunUploadServerApplication {
          public static void main(String[] args) {
              SpringApplication.run(RunUploadServerApplication.class);
          }
      }
      ```

   4. 新建包com.baidu.shop.upload.controller，

   5. 在包下新建UploadController

      ```java
      package com.baidu.shop.upload.controller;
      
      import com.baidu.shop.base.BaseApiService;
      import com.baidu.shop.base.Result;
      import com.baidu.shop.status.HTTPStatus;
      import org.springframework.beans.factory.annotation.Value;
      import org.springframework.web.bind.annotation.*;
      import org.springframework.web.multipart.MultipartFile;
      
      import java.io.File;
      import java.io.IOException;
      import java.util.UUID;
      
      /**
       * 2 * @ClassName UploadController
       * 3 * @Description: TODO
       * 4 * @Author jiahang
       * 5 * @Date 2020/12/29
       * 6 * @Version V1.04
       * 7
       **/
      @RestController
      @RequestMapping(value = "upload")
      public class UploadController extends BaseApiService {
          //linux系统的上传目录
          @Value(value = "${mingrui.upload.path.windows}")
          private String windowsPath;
          //window系统的上传目录
          @Value(value = "${mingrui.upload.path.linux}")
          private String linuxPath;
          //图片服务器的地址
          @Value(value = "${mingrui.upload.img.host}")
          private String imageHost;
          @PostMapping
          public Result<String> uploadImg(@RequestParam MultipartFile file) {
              if(file.isEmpty()) return this.setResultError("上传的文件为空");//判断上传的
              //文件是否为空
              String filename = file.getOriginalFilename();//获取文件名
              String path = "";
              String os = System.getProperty("os.name").toLowerCase();
              if(os.indexOf("win") != -1){
                  path = windowsPath;
              }else if(os.indexOf("lin") != -1){
                  path = linuxPath;
              }
              filename = UUID.randomUUID() + filename;//防止文件名重复
              //创建文件 路径+分隔符(linux和window的目录分隔符不一样)+文件名
              File dest = new File(path + File.separator + filename);
              //判断文件夹是否存在,不存在的话就创建
              if(!dest.getParentFile().exists()) dest.getParentFile().mkdirs();
              try {
                  file.transferTo(dest);//上传
              } catch (IllegalStateException e) {
              // TODO Auto-generated catch block
                  e.printStackTrace();
              } catch (IOException e) {
              // TODO Auto-generated catch block
                  e.printStackTrace();
              }
              return this.setResult(HTTPStatus.OK,"upload success!!!",imageHost + "/"+ filename);//将文件名返回页面用于页面回显
          }
      
      }
      ```

   6. 新建包:com.baidu.global

   7. GlobalCorsConfig

      ```java
      package com.baidu.global;
      
      import org.springframework.context.annotation.Bean;
      import org.springframework.context.annotation.Configuration;
      import org.springframework.web.cors.CorsConfiguration;
      import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
      import org.springframework.web.filter.CorsFilter;
      
      
      /**
       * 2 * @ClassName GlobalCorsConfig
       * 3 * @Description: TODO
       * 4 * @Author jiahang
       * 5 * @Date 2020/12/29
       * 6 * @Version V1.0
       * 7
       **/
      @Configuration
      public class GlobalCorsConfig {
          @Bean
          public CorsFilter corsFilter() {
              final UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
              final CorsConfiguration config = new CorsConfiguration();
              config.setAllowCredentials(true); // 允许cookies跨域
              config.addAllowedOrigin("*");// 允许向该服务器提交请求的URI，*表示全部允许。。这里尽量限制来源域，比如http://xxxx:8080 ,以降低安全风险。。
              config.addAllowedHeader("*");// 允许访问的头信息,*表示全部
              config.setMaxAge(18000L);// 预检请求的缓存时间（秒），即在这个时间段里，对于相同的跨域请求不会再预检了
              config.addAllowedMethod("*");// 允许提交请求的方法，*表示全部允许，也可以单独设置GET、PUT等
              config.addAllowedMethod("HEAD");
              config.addAllowedMethod("GET");// 允许Get的请求方法
              config.addAllowedMethod("PUT");
              config.addAllowedMethod("POST");
              config.addAllowedMethod("DELETE");
              config.addAllowedMethod("PATCH");
              source.registerCorsConfiguration("/**", config);
              //3.返回新的CorsFilter.
              return new CorsFilter(source);
          }
      
      }
      ```

   8. 使用postman测试上传

      ![image-20210105153944281](D:\MD文件图片\image-20210105153944281.png)

   9. 我们将利用nginx来做代理服务,代理本地目录

   10.  hosts文件中新增

       ```
       127.0.0.1 image.mrshop.com
       ```

   11. nginx-home/conf/nginx.conf新增

       ```java
       	server {
               listen 	80;
               server_name image.mrshop.com;
               
               proxy_set_header X-Forwarded-Host $host;
               proxy_set_header X-Forwarded-Server $host;
               proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
               
               location ~ .*\.(gif|jpg|pdf|jpeg|png)$
               {
               	#root D:/nginx-1.15.5/temp/images/;#指定图片存放路径(可以放在nginx文件夹路
              	 	径里也可以放其他p盘)
               	root E:\images;
               }
               
               location / {
           		root html;
           		index index.html index.htm;
           	}
           }
       
       ```

       

   12. 重启nginx

       ```
       nginx.exe -s reload
       ```

   13. 浏览器输入http://image.mrshop.com/imageName.jpg测试

   14. zuul的application.yml

       ```
       zuul:
         # 声明路由
         routes:
           # 路由名称
           api-xxx:
             # 声明将所有以/api-ribbon/的请求都转发到eureka-ribbon的服务中
             path: /api-xxx/**
             serviceId: xxx-server
         # 启用重试
         retryable: true
         # 包含此路径的不进行路由
         ignored-patterns: /upload/**
         # 忽略上传服务
         ignored-services:
           -upload-server
       
       ```

       

   15. 在nginx-home/conf/nginx.conf 添加api.mrshop.com的代理配置

       ```
           # 上传路径的映射
           # 只要包含/api-xxx/upload 都会把请求映射到8200服务
           # rewrite "^/api-xxx/(.*)$" /$1 break;
           # 将/api-xxx 替换成/
           location /api-xxx/upload {
               proxy_pass http://127.0.0.1:8200;
               proxy_connect_timeout 600;
               proxy_read_timeout 600;
               
               rewrite "^/api-xxx/(.*)$" /$1 break;
           }
       
       ```

       

   



# 四，商品规格参数管理

#### 1 加载分类信息

##### 1.1 vue项目

###### 1.1.1 index.js line:29

```javascript
route("/item/specification",'/item/specification/Specification',"Specification"),
```

###### 1.1.2 specification/Specification.vue

```html
<!--修改成我们自己的url-->
<v-tree url="/category/list"
                  :isEdit="false"
                  @handleClick="handleClick"
          />
```

#### 2 规格组(查询)

##### 2.1 vue项目 

##### 2.1.1 SpecGroup.vue

line:72，路径

```javascript
loadData(){
          this.$http.get("/specgroup/groups" , {
              params:{
                  cid:this.cid
              }
          })
          .then(({data}) => {
              this.groups = data.data;
          })
          .catch(() => {
              this.groups = [];
          })
      },
```

##### 2.2 mingrui-shop-service-api-xxx

##### 2.2.1 entity包下新建SpecGroupEntity

```java
import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;

/**
 * 2 * @ClassName SpecGroupEntity
 * 3 * @Description: TODO
 * 4 * @Author jiahang
 * 5 * @Date 2021/1/4
 * 6 * @Version V1.0
 * 7
 **/
@Table(name = "tb_spec_group")
@Data
public class SpecGroupEntity {

    @Id
    private Integer id;

    private Integer cid;

    private String name;
}
```

##### 2.2.2 dto包下新建SpecGroupDTO

```java
import com.baidu.shop.base.BaseDTO;
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;

/**
 * 2 * @ClassName SpecGroupDTO
 * 3 * @Description: TODO
 * 4 * @Author jiahang
 * 5 * @Date 2021/1/4
 * 6 * @Version V1.0
 * 7
 **/
@ApiModel(value = "规格组数据传输DTO")
@Data
public class SpecGroupDTO extends BaseDTO {

    @ApiModelProperty(value = "主键",example = "1")
    @NotNull(message = "主键id不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "分类id",example = "1")
    @NotNull(message = "类型Id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid;

    @ApiModelProperty(value = "规格组名称")
    @NotEmpty(message = "规格组名称不能为空",groups = {MingruiOperation.Add.class})
    private String name;
}
```

##### 2.2.3 service包下新建SpecificationService

```java
import com.baidu.shop.base.Result;
import com.baidu.shop.dto.SpecGroupDTO;
import com.baidu.shop.entity.SpecGroupEntity;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.*;

@Api(tags = "规格接口")
public interface SpecificationService {

    @ApiOperation(value = "通过条件查询规格组")
    @GetMapping(value = "specgroup/groups")
    Result<List<SpecGroupEntity>> getSepcGroupInfo(SpecGroupDTO specGroupDTO);
}
```

##### 2.3 mingrui-shop-service-xxx 

##### 2.3.1 mapper包下新建SpecGroupMapper

```java
import com.baidu.shop.entity.SpecGroupEntity;
import tk.mybatis.mapper.common.Mapper;

public interface SpecGroupMapper extends Mapper<SpecGroupEntity> {
}
```

##### 2.3.2 service.impl包下新建SpecificationServiceImpl

```java
import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.dto.SpecGroupDTO;
import com.baidu.shop.entity.SpecGroupEntity;
import com.baidu.shop.mapper.SpecGroupMapper;
import com.baidu.shop.service.SpecificationService;
import com.baidu.shop.utils.ObjectUtil;
import org.springframework.util.StringUtils;
import org.springframework.web.bind.annotation.RestController;
import tk.mybatis.mapper.entity.Example;
import javax.annotation.Resource;
import java.util.List;

@RestController
public class SpecificationServiceImpl extends BaseApiService implements SpecificationService {

    @Resource
    private SpecGroupMapper specGroupMapper;
    
    @Override
    public Result<List<SpecGroupEntity>> getSepcGroupInfo(SpecGroupDTO specGroupDTO) {
        Example example = new Example(SpecGroupEntity.class);
        if (ObjectUtil.isNotNull(specGroupDTO.getCid()))
            example.createCriteria().andEqualTo("cid", BaiduBeanUtil.copyProperties(specGroupDTO,SpecGroupEntity.class).getCid());
        
        List<SpecGroupEntity> specGroupEntities = specGroupMapper.selectByExample(example);
        return this.setResultSuccess(specGroupEntities);
    }
}
```

#### 3 规格组(新增,删除,修改)

##### 3.1 vue项目 

###### 3.1.1 SpecGroup.vue

```js
save(){
           this.$http({
            method: this.isEdit ? 'put' : 'post',
            url: '/specgroup/save',
            data: this.group
          }).then(() => {
            // 关闭窗口
            this.show = false;
            this.$message.success("保存成功！");
            this.loadData();
          }).catch(() => {
              this.$message.error("保存失败！");
            });
      },
      deleteGroup(id){
          this.$message.confirm("确认要删除分组吗？")
          .then(() => {
            this.$http.delete("specgroup/delete/" + id)
                .then(resp => {
                    if (resp.data.code != 200) {
                        this.$message.error(resp.data.message);
                        return;
                    }
                    this.$message.success("删除成功");
                    this.loadData();
                })
          })
      },
```

##### 3.2 mingrui-shop-service-api-xxx 

###### 3.2.1 SpecificationService

```java
 @ApiOperation(value = "增加规格组")
    @PostMapping(value = "specgroup/save")
    Result<JsonObject> saveSpecGroup(@RequestBody SpecGroupDTO specGroupDTO);

    @ApiOperation(value = "修改规格组")
    @PutMapping(value = "specgroup/save")
    Result<JsonObject> editSpecGroup(@RequestBody SpecGroupDTO specGroupDTO);

    @ApiOperation(value = "删除规格组")
    @DeleteMapping(value = "specgroup/delete/{id}")
    Result<JsonObject> deleteSpecGroup(@PathVariable Integer id);
```

##### 3.3 mingrui-shop-service-xxx 

###### 3.3.1 SpecificationServiceImpl

```java
 @Resource
 private SpecParamMapper specParamMapper;

@Transactional
    @Override
    public Result<JsonObject> saveSpecGroup(SpecGroupDTO specGroupDTO) {
        specGroupMapper.insertSelective(BaiduBeanUtil.copyProperties(specGroupDTO,SpecGroupEntity.class));

        return this.setResultSuccess();
    }

    @Transactional
    @Override
    public Result<JsonObject> editSpecGroup(SpecGroupDTO specGroupDTO) {
        specGroupMapper.updateByPrimaryKeySelective(BaiduBeanUtil.copyProperties(specGroupDTO,SpecGroupEntity.class));
        return this.setResultSuccess();
    }

    @Transactional
    @Override
    public Result<JsonObject> deleteSpecGroup(Integer id) {

        //删除规格组之前需要先判断一下当前规格组下是否有规格参数
        //true : 不能被删除
        //false -->
        Example example = new Example(SpecParamEntity.class);
        example.createCriteria().andEqualTo("groupId",id);
        List<SpecParamEntity> specParamEntities = specParamMapper.selectByExample(example);
        
        if (specParamEntities.size()!=0) return this.setResultError(HTTPStatus.OPERATION_ERROR,"当前规格组下有参数，请先删除规格组下的内容");

        specGroupMapper.deleteByPrimaryKey(id);
        return this.setResultSuccess();
    }
```

#### 4 规格参数(查询) 

##### 4.1 vue项目 

###### 4.1.1 SpecParam.vue

line:125

```js
loadData() {
      this.$http
        .get("/specparam/groups",{
          params:{
            groupId:this.group.id
          }
        })
        .then((resp) => {
          resp.data.data.forEach(p => {
              p.segments = p.segments ? p.segments.split(",").map(s => s.split("-")) : [];
          })
          this.params = resp.data.data;
        })
        .catch(() => {
          this.params = [];
        });
    },
```

##### 4.2 mingrui-shop-service-api-xxx 

###### 4.2.1 entity包下新建SpecParamEntity

```java
import lombok.Data;

import javax.persistence.Column;
import javax.persistence.Id;
import javax.persistence.Table;

/**
 * 2 * @ClassName SpecParamEntity
 * 3 * @Description: TODO
 * 4 * @Author jiahang
 * 5 * @Date 2021/1/4
 * 6 * @Version V1.0
 * 7
 **/
@Table(name = "tb_spec_param")
@Data
public class SpecParamEntity {
    @Id
    private Integer id;

    private Integer cid;

    private Integer groupId;

    private String name;

    //1左边的点，numeric是数据库关键字
    @Column(name = "`numeric`")
    private Boolean numeric;

    private String unit;

    private Boolean generic;

    private Boolean searching;

    private String segments;

}

```

###### 4.2.2 dto包下新建SpecParamDTO

```java
import com.baidu.shop.base.BaseDTO;
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.validation.constraints.NotNull;

/**
 * 2 * @ClassName SpecParamDTO
 * 3 * @Description: TODO
 * 4 * @Author jiahang
 * 5 * @Date 2021/1/4
 * 6 * @Version V1.0
 * 7
 **/
@ApiModel(value = "规格参数数据传输DTO")
@Data
public class SpecParamDTO extends BaseDTO {

    @ApiModelProperty(value = "主键",example = "1")
    @NotNull(message = "主键不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "分类id",example = "1")
    private Integer cid;

    @ApiModelProperty(value = "规格组id")
    private Integer groupId;

    @ApiModelProperty(value = "规格参数名称")
    private String name;

    @ApiModelProperty(value = "是否是数字类型参数",example = "0")
    @NotNull(message = "是否是数字类型参数不能为空",groups = {MingruiOperation.Update.class})
    private Boolean numeric;

    @ApiModelProperty(value = "数字类型参数的单位，非数字类型可以为空")
    private String unit;

    @ApiModelProperty(value = "是否是sku通用属性")
    @NotNull(message = "是否是sku通用属性不能为空",groups = {MingruiOperation.Update.class,MingruiOperation.Add.class})
    private Boolean generic;

    @ApiModelProperty(value = "是否用于搜索过滤")
    @NotNull(message = "是否用于搜索过滤不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private Boolean searching;

    @ApiModelProperty(value = "数值类型参数，如果需要搜索，则添加分段间隔值")
    private String segments;
}

```

###### 4.2.3 SpecificationService

```java
    @ApiOperation(value = "查询规格参数")
    @GetMapping(value = "/specparam/groups")
    Result<List<SpecParamEntity>> getSepcParamInfo(SpecParamDTO specParamDTO);
```

##### 4.3 mingrui-shop-service-xxx 

###### 4.3.1 mapper包下新建SpecParamMapper

```java
import com.baidu.shop.entity.SpecParamEntity;
import tk.mybatis.mapper.common.Mapper;

public interface SpecParamMapper extends Mapper<SpecParamEntity> {
}
```

##### 4.3.2 SpecificationServiceImpl

```java
	//@Resource
	//private SpecParamMapper specParamMapper;
	
	@Override
    public Result<List<SpecParamEntity>> getSepcParamInfo(SpecParamDTO specParamDTO) {
        SpecParamEntity specParamEntity = 
            BaiduBeanUtil.copyProperties(specParamDTO, SpecParamEntity.class);

        Example example = new Example(SpecParamEntity.class);
        example.createCriteria().andEqualTo("groupId",specParamEntity.getGroupId());
        List<SpecParamEntity> specParamEntities = 													specParamMapper.selectByExample(example);
        
        return this.setResultSuccess(specParamEntities);
    }
```

#### 5 规格参数(增,删,改) 

##### 5.1 vue项目 

3.5.1.1 SpecParam.vue

line:156

```js
addParam() {
      this.param = {
          cid: this.group.cid,
          groupId: this.group.id,
          segments:[],
          numeric:false,
          searching:false,
          generic:false}
      this.show = true;
      this.isEdit = false;
    },
```

```js
deleteParam(id) {
        this.$message.confirm("确认要删除该参数吗？")
        .then(() => {
            this.$http.delete("specparam/delete?id=" + id)
            .then(() => {
              
                this.$message.success("删除成功");
                this.loadData();
            })
            .catch(() => {
                this.$message.error("删除失败");
            })
        })
    },
    formatBoolean(boo) {
      return boo ? "是" : "否";
    },
    save(){
        const p = {};
        Object.assign(p, this.param);
        p.segments = p.segments.map(s => s.join("-")).join(",")
        this.$http({
            method: this.isEdit ? 'put' : 'post',
            url: '/specparam/save',
            data: p,
        }).then(() => {
            // 关闭窗口
            this.show = false;
            this.$message.success("保存成功！");
            this.loadData();
          }).catch(() => {
              this.$message.error("保存失败！");
            });
    }
```

##### 5.2 mingrui-shop-service-api-xxx 

5.2.1 SpecificationService

```java
@ApiOperation(value = "增加规格参数")
    @PostMapping(value = "/specparam/save")
    Result<JsonObject> saveSpecParam(@RequestBody SpecParamDTO specParamDTO);

    @ApiOperation(value = "修改规格参数")
    @PutMapping(value = "/specparam/save")
    Result<JsonObject> editSpecParam(@RequestBody SpecParamDTO specParamDTO);


    @ApiOperation(value = "删除规格参数")
    @DeleteMapping(value = "/specparam/delete")
    Result<JsonObject> deleteSpecParam(Integer id);
```

#####  mingrui-shop-service-xxx 

######  SpecificationServiceImpl

```java
@Transactional
    @Override
    public Result<JsonObject> saveSpecParam(SpecParamDTO specParamDTO) {
        specParamMapper.insertSelective(BaiduBeanUtil.copyProperties(specParamDTO,SpecParamEntity.class));
        return this.setResultSuccess();
    }

    @Transactional
    @Override
    public Result<JsonObject> editSpecParam(SpecParamDTO specParamDTO) {
        specParamMapper.updateByPrimaryKeySelective(BaiduBeanUtil.copyProperties(specParamDTO,SpecParamEntity.class));
        return this.setResultSuccess();
    }

    @Transactional
    @Override
    public Result<JsonObject> deleteSpecParam(Integer id) {
        specParamMapper.deleteByPrimaryKey(id);
        return this.setResultSuccess();
    }
```



# 五，商品管理

## 查询

#### Goods.vue

line: 9 , 12 ,15                         true=1,false=0

```vue
		状态：
        <v-btn-toggle mandatory v-model="search.saleable">
          <v-btn flat :value="2">
            全部
          </v-btn>
          <v-btn flat :value="1">
            上架
          </v-btn>
          <v-btn flat :value="0">
            下架
          </v-btn>
        </v-btn-toggle>
```

line: 203          把测试数据删了，请求后台数据

```vue
getDataFromApi() {
        this.loading = true;
        this.$http.get("/goods/getSpuInfo",{
          params:{
            page: this.pagination.page,
            rows: this.pagination.rowsPerPage,
            sort: this.pagination.sortBy,
            order: this.pagination.descending,
            saleable: this.search.saleable,
            title: this.search.key
          }
        }).then(resp => {
          this.items=resp.data.data.list;
          this.totalItems=resp.data.data.total;
          this.loading=false;
          console.log(resp.data.data.list)
        }).catch(error => console.log(error))
      }
```

####  mingrui-shop-service-api-xxx

#####  entity包下新建SpuEntity

```java
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;
import java.util.Date;

/**
 * 2 * @ClassName SpuEntity
 * 3 * @Description: TODO
 * 4 * @Author jiahang
 * 5 * @Date 2021/1/5
 * 6 * @Version V1.0
 * 7
 **/
@Table(name = "tb_spu")
@Data
public class SpuEntity {
    @Id
    private Integer id;

    private String title;

    private String subTitle;

    private Integer cid1;

    private Integer cid2;

    private Integer cid3;

    private Integer brandId;

    private Integer saleable;

    private Integer valid;

    private Date createTime;

    private Date lastUpdateTime;

}
```

#####  dto包下新建SpuDTO

```java
package com.baidu.shop.dto;

import com.baidu.shop.base.BaseDTO;
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;
import java.util.Date;

/**
 * 2 * @ClassName SpuDTO
 * 3 * @Description: TODO
 * 4 * @Author jiahang
 * 5 * @Date 2021/1/5
 * 6 * @Version V1.0
 * 7
 **/
@ApiModel(value = "spu数据传输DTO")
@Data
public class SpuDTO extends BaseDTO {

    @ApiModelProperty(value = "主键",example = "1")
    @NotNull(message = "主键不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "标题")
    @NotEmpty(message = "标题不能为空",groups = {MingruiOperation.Add.class})
    private String title;

    @ApiModelProperty(value = "子标题")
    private String subTitle;

    @ApiModelProperty(value = "1级类目id",example = "1")
    @NotNull(message = "1级类目id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid1;

    @ApiModelProperty(value = "2级类目id",example = "1")
    @NotNull(message = "2级类目id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid2;

    @ApiModelProperty(value = "3级类目id",example = "1")
    @NotNull(message = "3级类目id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid3;

    @ApiModelProperty(value = "商品所属品牌id")
    @NotNull(message = "商品所属品牌id不能为空",groups = {MingruiOperation.Add.class})
    private Integer brandId;

    //不需要验证,新增时直接设置默认值
    @ApiModelProperty(value = "是否上架，0下架，1上架",example = "1")
    private Integer saleable;

    //不需要验证,新增时直接设置默认值
    @ApiModelProperty(value = "是否有效，0已删除，1有效",example = "1")
    private Integer valid;

    //不需要验证,新增时直接设置默认值
    @ApiModelProperty(value = "添加时间")
    private Date createTime;

    //不需要验证,新增时直接设置默认值,修改时使用java代码赋值
    @ApiModelProperty(value = "最后修改时间")
    private Date lastUpdateTime;
    
    //用于存储商品分类名
    private String brandName;
    
    //用于存储品牌名
	private String categoryName;


    
}
```

##### 

##### service包下新建GoodsService

```java

import com.baidu.shop.base.Result;
import com.baidu.shop.dto.SpuDTO;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.GetMapping;

import java.util.List;

@Api(tags = "商品接口")
public interface GoodsService {

    @ApiOperation(value = "获取spu信息")
    @GetMapping(value = "/goods/getSpuInfo")
    Result<List<SpuDTO>> getSpuInfo(SpuDTO spuDTO);
}
```

#### mingrui-shop-service-xxx

###### mapper包下新建SpuMapper

```java
import com.baidu.shop.entity.SpuEntity;
import tk.mybatis.mapper.common.Mapper;

public interface SpuMapper extends Mapper<SpuEntity> {
}
```

##### 修改CategoryMapper ，用于查询商品分类的name名，因为要查出来的分类名是多个值，所以又继承了一个

##### SelectByIdListMapper，第一个泛型是根据哪个类，第二个是查询参数的类型

```java
import com.baidu.shop.entity.CategoryEntity;
import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.additional.idlist.SelectByIdListMapper;
import tk.mybatis.mapper.common.Mapper;

import java.util.List;

//可以通过id集合查询
public interface CategoryMapper extends Mapper<CategoryEntity>, SelectByIdListMapper<CategoryEntity,Integer> {

    @Select(value = "SELECT id,name from tb_category where id in (select category_id from tb_category_brand where brand_id=#{brandId})")
    List<CategoryEntity> getCategoryByBrandId(Integer brandId);
}
```

######  service.impl包下新建GoodsServiceImpl

```java
import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.dto.SpuDTO;
import com.baidu.shop.entity.BrandEntity;
import com.baidu.shop.entity.CategoryEntity;
import com.baidu.shop.entity.SpuEntity;
import com.baidu.shop.mapper.BrandMapper;
import com.baidu.shop.mapper.CategoryMapper;
import com.baidu.shop.mapper.SpuMapper;
import com.baidu.shop.service.GoodsService;
import com.baidu.shop.status.HTTPStatus;
import com.baidu.shop.utils.BaiduBeanUtil;
import com.baidu.shop.utils.ObjectUtil;
import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import org.apache.commons.lang.StringUtils;
import org.springframework.web.bind.annotation.RestController;
import tk.mybatis.mapper.entity.Example;

import javax.annotation.Resource;
import java.util.Arrays;
import java.util.List;
import java.util.stream.Collectors;

/**
 * 2 * @ClassName GoodsServiceImpl
 * 3 * @Description: TODO
 * 4 * @Author jiahang
 * 5 * @Date 2021/1/5
 * 6 * @Version V1.0
 * 7
 **/
@RestController
public class GoodsServiceImpl extends BaseApiService implements GoodsService {
    @Resource
    private SpuMapper spuMapper;
    @Resource
    private BrandMapper brandMapper;
    @Resource
    private CategoryMapper categoryMapper;

    @Override
    public Result<List<SpuDTO>> getSpuInfo(SpuDTO spuDTO) {
        //分页
        if (ObjectUtil.isNotNull(spuDTO.getPage()) && ObjectUtil.isNotNull(spuDTO.getRows()))
            PageHelper.startPage(spuDTO.getPage(),spuDTO.getRows());

        Example example = new Example(SpuEntity.class);
        Example.Criteria criteria = example.createCriteria();
        //判断是否上架，如果值为空或者<2，就是1，0的时候，1是上架，0是下架
        if (ObjectUtil.isNotNull(spuDTO.getSaleable()) && spuDTO.getSaleable()<2)
            criteria.andEqualTo("saleable",spuDTO.getSaleable());
        //按标题模糊匹配
        if (!StringUtils.isEmpty(spuDTO.getTitle()))
            criteria.andLike("title","%"+spuDTO.getTitle()+"%");
        //排序
        if (!StringUtils.isEmpty(spuDTO.getSort()))
            example.setOrderByClause(spuDTO.getOrderBy());

        List<SpuEntity> spuEntities = spuMapper.selectByExample(example);

        List<SpuDTO> spuDTOList = spuEntities.stream().map(spuEntity -> {
            SpuDTO spuDTO1 = BaiduBeanUtil.copyProperties(spuEntity, SpuDTO.class);

            //分类名称 cid1 + cid2 + cid3
            /*CategoryEntity categoryEntity1 = categoryMapper.selectByPrimaryKey(spuEntity.getCid1());
            CategoryEntity categoryEntity2 = categoryMapper.selectByPrimaryKey(spuEntity.getCid2());
            CategoryEntity categoryEntity3 = categoryMapper.selectByPrimaryKey(spuEntity.getCid3());
            spuDTO1.setCategoryName(categoryEntity1+"/"+categoryEntity2+"/"+categoryEntity3);*/

            /*List<Integer> cidList = new ArrayList<>();
            cidList.add(spuEntity.getCid1());
            cidList.add(spuEntity.getCid2());
            cidList.add(spuEntity.getCid3());*/
//            List<Integer> cidList = Arrays.asList(spuEntity.getCid1(), spuEntity.getCid2(), spuEntity.getCid3());

            //通过分类id集合查询数据
            List<CategoryEntity> categoryEntities = categoryMapper.selectByIdList(Arrays.asList(spuEntity.getCid1(), spuEntity.getCid2(), spuEntity.getCid3()));
            // 遍历集合并且将分类名称用 / 拼接
            // 3/1/2
            //ajax --> 并不是所有情况都要用异步 jquery.validate 验证用户名存在不存在
            String categoryName = categoryEntities.stream().map(categoryEntity -> categoryEntity.getName()).collect(Collectors.joining("/"));
            //将在商品分类表中查到的商品分类名赋值给商品表中的商品分类名
            spuDTO1.setCategoryName(categoryName);
//            String categoryName="";
//            List<String> strings = new ArrayList<>();
//            strings.set(0,"");
//            categoryEntities.stream().forEach(categoryEntity -> {
//                strings.set(0,strings.get(0) + categoryEntity.getName() + "/");
//            });
//            categoryName=strings.get(0).substring(0,strings.get(0).length());



            //根据商品中的brandid到品牌表查询品牌名字
            BrandEntity brandEntity = brandMapper.selectByPrimaryKey(spuEntity.getBrandId());
            //将在品牌表中查到的品牌名赋值给商品表中的品牌名
            spuDTO1.setBrandName(brandEntity.getName());

            return spuDTO1;
        }).collect(Collectors.toList());
        
        PageInfo<SpuEntity> spuEntityPageInfo = new PageInfo<>(spuEntities);
        //把分页的数据放在message中传到页面
        //返回的是  一：Integer类型的code，二：String类型的message，三：Object类型的data
        return this.setResult(HTTPStatus.OK,spuEntityPageInfo.getTotal()+"",spuDTOList);
    }
}
```

![image-20210106154023025](D:\MD文件图片\image-20210106154023025.png)

## 新增

### 新增添加数据

#### GoodsForm.vue

  line:283  			请求到后台查询

```vue
		// 根据分类查询品牌
          this.$http
            .get("/brand/getBrandInfoByCategoryId",{
              params:{
                cid:this.goods.categories[2].id
              }
            } )
            .then((resp) => {
              this.brandOptions = resp.data.data;
            });		
```

#### BrandService

```
	@ApiOperation(value = "根据分类查询品牌")
    @GetMapping(value = "/brand/getBrandInfoByCategoryId")
    Result<List<BrandEntity>> getBrandInfoByCategoryId(Integer cid);
```

#### BrandMapper

自定义查询方法，根据分类id查询品牌信息，*可以换成id，name

```java
import com.baidu.shop.entity.BrandEntity;
import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.common.Mapper;

import java.util.List;

public interface BrandMapper extends Mapper<BrandEntity> {
    @Select(value = "select * from tb_brand b where b.id in (select cb.brand_id from tb_category_brand cb where cb.category_id=#{cid})")
    List<BrandEntity> getBrandInfoByCategoryId(Integer cid);
}
```

#### BrandServiceImpl

```java
@Override
public Result<List<BrandEntity>> getBrandInfoByCategoryId(Integer cid) {
    //使用自定义查询方法
    List<BrandEntity> list=brandMapper.getBrandInfoByCategoryId(cid);
    return this.setResultSuccess(list);
}
```

#### 据分类查询规格参数+图片上传↓

#### GoodsForm.vue

line:293

```vue
		// 根据分类查询规格参数
          this.$http
            .get("/specparam/groups",{
                params:{
                  cid:this.goods.categories[2].id
                }
            } )
```

line:300

```vue
		 .then((resp) => {
              let specs = [];
              let template = [];
              if (this.isEdit){
                specs = JSON.parse(this.goods.spuDetail.genericSpec);
                template = JSON.parse(this.goods.spuDetail.specialSpec);
              }
              // 对特有规格进行筛选
              const arr1 = [];
              const arr2 = [];
              resp.data.data.forEach(({id, name,generic, numeric, unit }) => {
```

line:57   		路径改为自己后台的上传路径

```
 <v-editor v-model="goods.spuDetail.description" upload-url="/upload"/>
```

line:118

```vue
<!--图片上传组件-->
<v-upload v-model="props.item.images" url="/upload"/>
```

#### Editor.vue

line：95

```
this.$http.post(this.uploadUrl, data)
          .then(res => {
            if (res.data.data) {
              this.editor.insertEmbed(this.editor.getSelection().index, 'image', res.data.data)
            }
          })
```

#### SpecificationServiceImpl

先判断传过去的值是不是空，然后根据分类查询规格参数

```java
@Override
public Result<List<SpecParamEntity>> getSepcParamInfo(SpecParamDTO specParamDTO) {
    SpecParamEntity specParamEntity = BaiduBeanUtil.copyProperties(specParamDTO, SpecParamEntity.class);

    Example example = new Example(SpecParamEntity.class);
    Example.Criteria criteria = example.createCriteria();

    if (ObjectUtil.isNotNull(specParamEntity.getGroupId()))
        criteria.andEqualTo("groupId",specParamEntity.getGroupId());
    if (ObjectUtil.isNotNull(specParamEntity.getCid()))
        criteria.andEqualTo("cid",specParamEntity.getCid());

    List<SpecParamEntity> specParamEntities = specParamMapper.selectByExample(example);
    return this.setResultSuccess(specParamEntities);
}
```

#### JavaScript 值转换为 JSON 字符串。————>JSON.stringify(JavaScript 值）方法

例如字符串转JSON 		 **JSON.stringify(String类型的值)**

#### JSON转字符串	————>	JSON.parse(JSON类型的值) 方法



###  商品管理(新增[传值接值])

![新增](D:\MD文件图片\新增.png)

#### mingrui-shop-service-api-xxx

在entity包下新建实体类：

##### SpuDetailEntity

```java
import lombok.Data;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.Table;
import java.util.Date;

/**
 * 2 * @ClassName SpuEntity
 * 3 * @Description: TODO
 * 4 * @Author jiahang
 * 5 * @Date 2021/1/5
 * 6 * @Version V1.0
 * 7
 **/
@Table(name = "tb_spu")
@Data
public class SpuEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Integer id;

    private String title;

    private String subTitle;

    private Integer cid1;

    private Integer cid2;

    private Integer cid3;

    private Integer brandId;

    private Integer saleable;

    private Integer valid;

    private Date createTime;

    private Date lastUpdateTime;

}
```

##### SkuEntity

```java
import lombok.Data;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.Table;
import java.util.Date;

/**
 * 2 * @ClassName SkuEntity
 * 3 * @Description: TODO
 * 4 * @Author jiahang
 * 5 * @Date 2021/1/7
 * 6 * @Version V1.0
 * 7
 **/
@Table(name = "tb_sku")
@Data
public class SkuEntity {

    @Id//此处必须写long类型,因为现在新增的id已经超过int的范围了
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private Integer spuId;

    private String title;

    private String images;

    private Integer price;

    private String indexes;

    private String ownSpec;

    private Integer enable;

    private Date createTime;

    private Date lastUpdateTime;
}
```

##### StockEntity

```java
import lombok.Data;
import javax.persistence.Id;
import javax.persistence.Table;

/**
 * 2 * @ClassName StockEntity
 * 3 * @Description: TODO
 * 4 * @Author jiahang
 * 5 * @Date 2021/1/7
 * 6 * @Version V1.0
 * 7
 **/
@Table(name = "tb_stock")
@Data
public class StockEntity {

    @Id
    private Long skuId;

    private Integer seckillStock;

    private Integer seckillTotal;

    private Integer stock;

}
```

dto包下新建dto:

##### SpuDetailDTO

```java
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

/**
 * 2 * @ClassName SpuDetailDTO
 * 3 * @Description: TODO
 * 4 * @Author jiahang
 * 5 * @Date 2021/1/7
 * 6 * @Version V1.0
 * 7
 **/
@ApiModel(value = "spu大字段数据传输类")
@Data
public class SpuDetailDTO {

    @ApiModelProperty(value = "spu主键",example = "1")
    private Integer spuId;

    @ApiModelProperty(value = "商品描述信息")
    private String description;

    @ApiModelProperty(value = "通用规格参数数据")
    private String genericSpec;

    @ApiModelProperty(value = "特有规格参数及可选值信息，json格式")
    private String specialSpec;

    @ApiModelProperty(value = "包装清单")
    private String packingList;

    @ApiModelProperty(value = "售后服务")
    private String afterService;
}
```



##### SkuDTO

```java
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import java.util.Date;

/**
 * 2 * @ClassName SkuDTO
 * 3 * @Description: TODO
 * 4 * @Author jiahang
 * 5 * @Date 2021/1/7
 * 6 * @Version V1.0
 * 7
 **/
@ApiModel(value = "SKU属性数据传输类")
@Data
public class SkuDTO {

    @ApiModelProperty(value = "主键", example = "1")
    private Long id;

    @ApiModelProperty(value = "spu主键", example = "1")
    private Integer spuId;

    @ApiModelProperty(value = "商品标题")
    private String title;

    @ApiModelProperty(value = "商品的图片，多个图片以‘,’分割")
    private String images;

    @ApiModelProperty(value = "销售价格，单位为分", example = "1")
    private Integer price;

    @ApiModelProperty(value = "特有规格属性在spu属性模板中的对应下标组合")
    private String indexes;

    @ApiModelProperty(value = "sku的特有规格参数键值对，json格式，反序列化时请使用 linkedHashMap，保证有序")
    private String ownSpec;

    //注意此处使用boolean值来接,在service中处理一下就可以了
    @ApiModelProperty(value = "是否有效，0无效，1有效", example = "1")
    private Boolean enable;

    @ApiModelProperty(value = "添加时间")
    private Date createTime;

    @ApiModelProperty(value = "最后修改时间")
    private Date lastUpdateTime;

    @ApiModelProperty(value = "库存")
    private Integer stock;

}
```



##### StockDTO

```java
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

/**
 * 2 * @ClassName StockDTO
 * 3 * @Description: TODO
 * 4 * @Author jiahang
 * 5 * @Date 2021/1/7
 * 6 * @Version V1.0
 * 7
 **/
@ApiModel(value = "库存数据传输类")
@Data
public class StockDTO {

    @ApiModelProperty(value = "主键",example = "1")
    private Long skuId;

    @ApiModelProperty(value = "可秒杀库存", example = "1")
    private Integer seckillStock;

    @ApiModelProperty(value = "秒杀总数量", example = "1")
    private Integer seckillTotal;

    @ApiModelProperty(value = "库存数量", example = "1")
    private Integer stock;

}
```



##### 修改SpuDTO

```java
@ApiModelProperty(value = "大字段数据")
private SpuDetailDTO spuDetail;	//用来存前台传来的tb_spu_detail表中的数据

@ApiModelProperty(value = "sku属性数据集合")
private List<SkuDTO> skus;		//用来存前台传来的tb_sku表和tb_stock表中的数据
```

##### GoodsService

```java
@ApiOperation(value = "新增商品")
@PostMapping(value = "/goodss/save")
Result<JsonObject> saveGoods(@RequestBody SpuDTO spuDTO);
```

##### GoodsServiceImpl

```java
看值传过去没就行
```



### 商品管理(新增[入库])

#####  GoodsForm.vue

 line:277    		新增完关闭新增框

```
this.$emit("closeForm");
```



#### mingrui-shop-service-xxx

mapper包下新建mapper:

##### SpuDetailMapper

```java
import com.baidu.shop.entity.SpuDetailEntity;
import tk.mybatis.mapper.common.Mapper;

public interface SpuDetailMapper extends Mapper<SpuDetailEntity> {
}
```



##### SkuMapper

```java
package com.baidu.shop.mapper;

import com.baidu.shop.entity.SkuEntity;
import tk.mybatis.mapper.common.Mapper;

import java.util.List;

public interface SkuMapper extends Mapper<SkuEntity> {
    
}
```



##### StockMapper

```java
import com.baidu.shop.entity.StockEntity;
import tk.mybatis.mapper.common.Mapper;

public interface StockMapper extends Mapper<StockEntity> {
}
```



##### GoodsServiceImpl

```java
@Override
    public Result<List<SpuDTO>> getSpuInfo(SpuDTO spuDTO) {
        //分页
        if (ObjectUtil.isNotNull(spuDTO.getPage()) && ObjectUtil.isNotNull(spuDTO.getRows()))
            PageHelper.startPage(spuDTO.getPage(),spuDTO.getRows());

        Example example = new Example(SpuEntity.class);
        Example.Criteria criteria = example.createCriteria();
        //判断是否上架
        if (ObjectUtil.isNotNull(spuDTO.getSaleable()) && spuDTO.getSaleable()<2)
            criteria.andEqualTo("saleable",spuDTO.getSaleable());
        //根据title条件查询
        if (!StringUtils.isEmpty(spuDTO.getTitle()))
            criteria.andLike("title","%"+spuDTO.getTitle()+"%");

		//排序
        if (!StringUtils.isEmpty(spuDTO.getSort()) && !StringUtils.isEmpty(spuDTO.getOrder()))
            example.setOrderByClause(spuDTO.getOrderBy());

        List<SpuEntity> spuEntities = spuMapper.selectByExample(example);

        List<SpuDTO> spuDTOList = spuEntities.stream().map(spuEntity -> {
            SpuDTO spuDTO1 = BaiduBeanUtil.copyProperties(spuEntity, SpuDTO.class);

            //分类名称 cid1 + cid2 + cid3
            //通过分类id集合查询数据
            List<CategoryEntity> categoryEntities = categoryMapper.selectByIdList(Arrays.asList(spuEntity.getCid1(), spuEntity.getCid2(), spuEntity.getCid3()));
            // 遍历集合并且将分类名称用 / 拼接
            // 3/1/2
            //ajax --> 并不是所有情况都要用异步 jquery.validate 验证用户名存在不存在
            String categoryName = categoryEntities.stream().map(categoryEntity -> categoryEntity.getName()).collect(Collectors.joining("/"));
            spuDTO1.setCategoryName(categoryName);

            //查询品牌名字,并赋值给spuDto中的品牌名字
            BrandEntity brandEntity = brandMapper.selectByPrimaryKey(spuEntity.getBrandId());
            spuDTO1.setBrandName(brandEntity.getName());

            return spuDTO1;
        }).collect(Collectors.toList());
        PageInfo<SpuEntity> spuEntityPageInfo = new PageInfo<>(spuEntities);
        return this.setResult(HTTPStatus.OK,spuEntityPageInfo.getTotal()+"",spuDTOList);
    }
```



## 修改(回显数据)

vue项目

#### Goods.vue

169:editItem()中的内容

```vue
<template>
  <v-card>
    <v-toolbar class="elevation-0">
      <v-btn @click="addItem" color="primary">新增商品</v-btn>
      <v-spacer/>
      <v-flex xs3>
        状态：
        <v-btn-toggle mandatory v-model="search.saleable">
          <v-btn flat :value="2">
            全部
          </v-btn>
          <v-btn flat :value="1">
            上架
          </v-btn>
          <v-btn flat :value="0">
            下架
          </v-btn>
        </v-btn-toggle>
      </v-flex>
      <v-flex xs3>
        <v-text-field
          append-icon="search"
          label="搜索"
          single-line
          hide-details
          v-model="search.key"
        />
      </v-flex>
    </v-toolbar>
    <v-divider/>
    <v-data-table
      :headers="headers"
      :items="items"
      :pagination.sync="pagination"
      :total-items="totalItems"
      :loading="loading"
      class="elevation-1"
    >
      <template slot="items" slot-scope="props">
        <td class="text-xs-center">{{ props.item.id }}</td>
        <td class="text-xs-center">{{ props.item.title }}</td>
        <td class="text-xs-center">{{ props.item.categoryName}}</td>
        <td class="text-xs-center">{{ props.item.brandName }}</td>
        <td class="justify-center layout px-0">
          <v-btn icon small @click="editItem(props.item)">
            <i class="el-icon-edit"/>
          </v-btn>
          <v-btn icon small @click="deleteItem(props.item.id)">
            <i class="el-icon-delete"/>
          </v-btn>
          <v-btn icon small v-if="props.item.saleable">下架</v-btn>
          <v-btn icon v-else>上架</v-btn>
        </td>
      </template>
      <template slot="no-data">
        <v-alert :value="true" color="error" icon="warning">
          对不起，没有查询到任何数据 :(
        </v-alert>
      </template>
      <template slot="pageText" slot-scope="props">
        共{{props.itemsLength}}条,当前:{{ props.pageStart }} - {{ props.pageStop }}
      </template>
    </v-data-table>

    <v-dialog v-if="show" v-model="show" max-width="900" scrollable persistent>
      <v-card>
        <v-toolbar dense dark color="primary">
          <v-toolbar-title>{{isEdit ? '修改商品' : '新增商品'}}</v-toolbar-title>
          <v-spacer/>
          <v-btn icon @click="closeForm">
            <v-icon>close</v-icon>
          </v-btn>
        </v-toolbar>
        <v-card-text style="height: 600px;">
          <!-- 表单 -->
          <goods-form :oldGoods="selectedGoods" :isEdit="isEdit" :step="step" ref="goodsForm" @closeForm="closeForm"/>
        </v-card-text>
        <v-card-actions>
          <v-layout row justify-center>
            <v-flex xs2>
              <v-btn :disabled="step === 1" @click="lastStep">上一步</v-btn>
            </v-flex>
            <v-flex xs2>
              <v-btn :disabled="step === 4" color="primary" @click="nextStep">下一步</v-btn>
            </v-flex>
          </v-layout>
        </v-card-actions>
      </v-card>
    </v-dialog>
  </v-card>
</template>

<script>
  import GoodsForm from './GoodsForm'
  // import {goodsData} from "../../mockDB";

  export default {
    name: "item",
    components: {
      GoodsForm
    },
    data() {
      return {
        search: {
          key: '',
          saleable: true,
        },// 过滤字段
        totalItems: 0,// 总条数
        items: [],// 表格数据
        loading: true,
        pagination: {},// 分页信息
        headers: [// 表头
          {text: 'id', align: 'center', value: 'id'},
          {text: '标题', align: 'center', sortable: false, value: 'name'},
          {text: '商品分类', align: 'center', sortable: false, value: 'image'},
          {text: '品牌', align: 'center', value: 'letter', sortable: true,},
          {text: '操作', align: 'center', value: 'id', sortable: false}
        ],
        show: false,// 是否弹出窗口
        selectedGoods: null, // 选中的商品信息
        isEdit: false, // 判断是编辑还是新增
        step: 1// 表单中的导航条
      }
    },
    watch: {
      pagination: {
        handler() {
          this.getDataFromApi();
        },
        deep: true
      },
      search: {
        handler() {
          this.getDataFromApi();
        },
        deep: true
      }
    },
    mounted() {
      this.getDataFromApi();
    },
    methods: {
      closeForm() {
        this.isEdit = false;
        this.show = false;
        this.step = 1;
        this.selectedGoods = null;
        this.getDataFromApi();
      },
      lastStep() {
        if (this.step === 1) {
          return;
        }
        this.step--;
      },
      nextStep() {
        if (this.step === 4) {
          return;
        }
        if (this.$refs.goodsForm.$refs.basic.validate()) {
          this.step++;
        }
      },
      addItem() {
        this.selectedGoods = null;
        this.isEdit = false;
        this.show = true;
      },
      editItem(item) {

        this.isEdit = true;
        this.show = true;

        // this.selectedGoods = item;
        // const names = item.categoryName.split("/");
        // this.selectedGoods.categories = [
        //   {id: item.cid1, name: names[0]},
        //   {id: item.cid2, name: names[1]},
        //   {id: item.cid3, name: names[2]}
        // ];
        // 查询商品详情

        //只监控一次oldGoods
        let obj=item;
        this.$http.get("/goods/getSpuDetailBySpuId",{
          params:{
            spuId:item.id
          }
        })
          .then(resp => {
            obj.categories = [];//解决监控到的值为undefined
            obj.spuDetail = resp.data.data;
            obj.spuDetail.specTemplate = JSON.parse(resp.data.data.specialSpec);//特有规格参数
            obj.spuDetail.specifications = JSON.parse(resp.data.data.genericSpec);//通用规格参数
            // this.selectedGoods.spuDetail = resp.data.data;
            // this.selectedGoods.spuDetail.specTemplate = JSON.parse(resp.data.data.specTemplate);
            // this.selectedGoods.spuDetail.specifications = JSON.parse(resp.data.data.specifications);
            //通过spuId查询skus
            this.$http.get('/goods/getSkusBySpuId',{
              params:{
                spuId:item.id
              }
            }).then(resp => {
              obj.skus = resp.data.data;
              this.selectedGoods = obj;
            }).catch(error => console.log(error));
          })
        
      },
      deleteItem(id) {
        this.$message.confirm('此操作将永久删除该商品, 是否继续?')
          .then(() => {
            // 发起删除请求
            this.$http.delete("/item/goods?id=" + id)
              .then(() => {
                // 删除成功，重新加载数据
                this.getDataFromApi();
                this.$message.info('删除成功!');
              })
          })
          .catch(() => {
            this.$message.info('已取消删除');
          });

      },
      getDataFromApi() {
        this.loading = true;
        this.$http.get("/goods/getSpuInfo",{
          params:{
            page: this.pagination.page,
            rows: this.pagination.rowsPerPage,
            sort: this.pagination.sortBy,
            order: this.pagination.descending,
            saleable: this.search.saleable,
            title: this.search.key
          }
        }).then(resp => {
          // this.items=resp.data.data.list;
          this.items=resp.data.data;
          // this.totalItems=resp.data.data.total;
          //-0把字符串转为int类型的数值
          this.totalItems=resp.data.message-0;
          this.loading=false;
        }).catch(error => console.log(error))
        // setTimeout(() => {
        //   // 返回假数据
        //   this.items = goodsData.slice(0, 4);
        //   this.totalItems = 25;
        //   this.loading = false;
        // }, 300)
      }
    }
  }
</script>

<style scoped>
  label {
    font-size: 14px;
  }
</style>

```

#### GoodsForm.vue

line: 239     watch中的内容

```vue
<template>
  <v-stepper v-model="step">
    <v-stepper-header>
      <v-stepper-step :complete="step > 1" step="1">基本信息1</v-stepper-step>
      <v-divider/>
      <v-stepper-step :complete="step > 2" step="2">商品描述2</v-stepper-step>
      <v-divider/>
      <v-stepper-step :complete="step > 3" step="3">规格参数3</v-stepper-step>
      <v-divider/>
      <v-stepper-step step="4">SKU属性</v-stepper-step>
    </v-stepper-header>
    <v-stepper-items>
      <!--1、基本信息-->
      <v-stepper-content step="1">
        <v-flex class="xs10 mx-auto">
          <v-form v-model="valid" ref="basic">
            <v-layout row>
              <v-flex xs5>
                <!--商品分类-->
                <v-cascader
                  url="category/list"
                  required
                  showAllLevels
                  v-model="goods.categories"
                  label="请选择商品分类"/>
              </v-flex>
              <v-spacer/>
              <v-flex xs5>
                <!--品牌-->
                <v-select
                  :items="brandOptions"
                  item-text="name"
                  item-value="id"
                  label="所属品牌"
                  v-model="goods.brandId"
                  required
                  autocomplete
                  clearable
                  dense chips
                  :rules="[v => !!v || '品牌不能为空']"
                >
                  <template slot="selection" slot-scope="data">
                    <v-chip small>{{ data.item.name}}</v-chip>
                  </template>
                </v-select>
              </v-flex>
            </v-layout>
            <v-text-field label="商品标题" v-model="goods.title" :counter="200" required :rules="[v => !!v || '商品标题不能为空']" hide-details/>
            <v-text-field label="商品卖点" v-model="goods.subTitle" :counter="200" hide-details/>
            <v-text-field label="包装清单" v-model="goods.spuDetail.packingList" :counter="1000" multi-line :rows="3" hide-details/>
            <v-text-field label="售后服务" v-model="goods.spuDetail.afterService" :counter="1000" multi-line :rows="3" hide-details/>
          </v-form>
        </v-flex>
      </v-stepper-content>
      <!--2、商品描述-->
      <v-stepper-content step="2">
        <v-editor v-model="goods.spuDetail.description" upload-url="/upload"/>
      </v-stepper-content>
      <!--3、规格参数-->
      <v-stepper-content step="3">
        <v-flex class="xs10 mx-auto px-3">
          <!--遍历整个规格参数-->
          <v-card class="my-2">
            <v-container grid-list-md fluid>
            <v-layout wrap row justify-space-between class="px-5">
              <v-flex xs12 sm5 v-for="param in specs" :key="param.name">
                <v-text-field :label="param.name" v-model="param.v" :suffix="param.unit || ''"
                 />
              </v-flex>
            </v-layout>
          </v-container>
          </v-card>
        </v-flex>
      </v-stepper-content>
      <!--4、SKU属性-->
      <v-stepper-content step="4">
        <v-flex class="mx-auto">
          <!--遍历特有规格参数-->
          <v-card flat v-for="spec in specialSpecs" :key="spec.name">
            <!--特有参数的标题-->
            <div class="subheading">{{spec.name}}:</div>
            <!--特有参数的待选项，需要判断是否有options，如果没有，展示文本框，让用户自己输入-->
            <v-card-text class="px-5">
              <div v-for="i in spec.options.length+1" :key="i" class="layout row px-5">
                <v-text-field :placeholder="'新的' + spec.name + ':'" class="flex xs10" auto-grow
                              v-model="spec.options[i-1]" v-bind:value="i" single-line hide-details/>

                <v-btn @click="spec.options.splice(i-1,1)" v-if="i <= spec.options.length" icon>
                  <i class="el-icon-delete"/>
                </v-btn>
              </div>
            </v-card-text>
          </v-card>
          <v-card class="elevation-0">
            <!--标题-->
            <div class="subheading py-3">SKU列表:</div>
            <v-divider/>
            <!--SKU表格，hide-actions因此分页等工具条-->
            <v-data-table :items="skus" :headers="headers" hide-actions item-key="indexes" class="elevation-0">
              <template slot="items" slot-scope="props">
                <tr @click="props.expanded = !props.expanded">
                  <!--价格和库存展示为文本框-->
                  <td v-for="(v,k) in props.item" :key="k" v-if="['price', 'stock'].includes(k)"
                      class="text-xs-center">
                    <v-text-field single-line v-model="props.item[k]" @click.stop=""/>
                  </td>
                  <!--enable展示为checkbox-->
                  <td class="text-xs-center" v-else-if="k === 'enable'">
                    <v-checkbox v-model="props.item[k]"/>
                  </td>
                  <!--indexes和images不展示，其它展示为普通文本-->
                  <td class="text-xs-center" v-else-if="k !== 'images' && k !== 'indexes'">{{v.v}}</td>
                </tr>
              </template>
              <!--点击表格后展开-->
              <template slot="expand" slot-scope="props">
                <v-card class="elevation-2 flex xs11 mx-auto my-2">
                  <!--图片上传组件-->
                  <v-upload v-model="props.item.images" url="/upload"/>
                </v-card>
              </template>
            </v-data-table>
          </v-card>
        </v-flex>
        <!--提交按钮-->
        <v-flex xs3 offset-xs9>
          <v-btn color="info" @click="submit">保存商品信息</v-btn>
        </v-flex>
      </v-stepper-content>
    </v-stepper-items>
  </v-stepper>
</template>

<script>
export default {
  name: "goods-form",
  props: {
    oldGoods: {
      type: Object
    },
    isEdit: {
      type: Boolean,
      default: false
    },
    step: {
      type: Number,
      default: 1
    }
  },
  data() {
    return {
      valid:false,
      goods: {
        categories: [], // 商品分类信息
        brandId: 0, // 品牌id信息
        title: "", // 标题
        subTitle: "", // 子标题
        spuDetail: {
          packingList: "", // 包装列表
          afterService: "", // 售后服务
          description: "" // 商品描述
        }
      },
      brandOptions: [], // 品牌列表
      specs: [], // 规格参数的模板
      specialSpecs: [] // 特有规格参数模板
    };
  },
  methods: {
    submit() {
      // 表单校验。
      if(!this.$refs.basic.validate){
        this.$message.error("请先完成表单内容！");
      }
      // 先处理goods，用结构表达式接收,除了categories外，都接收到goodsParams中
      const {
        categories: [{ id: cid1 }, { id: cid2 }, { id: cid3 }],
        ...goodsParams
      } = this.goods;
      // 处理规格参数
      const specs = {};
      this.specs.forEach(({ id,v }) => {
        specs[id] = v;
      });
      // 处理特有规格参数模板
      const specTemplate = {};
      this.specialSpecs.forEach(({ id, options }) => {
        specTemplate[id] = options;
      });
      // 处理sku
      
      // console.log(this.skus);
      const skus = this.skus
        .filter(s => s.enable)
        .map(({ price, stock, enable, images, indexes, ...rest }) => {
          // 标题，在spu的title基础上，拼接特有规格属性值
          const title = goodsParams.title + " " + Object.values(rest).map(v => v.v).join(" ");
          const obj = {};
          Object.values(rest).forEach(v => {
            obj[v.id] = v.v;
          });
          return {
            price: this.$format(price), // 价格需要格式化
            stock,
            indexes,
            enable,
            title, // 基本属性
            images: images ? images.map(l=>{return l.data}).join(",") : '', // 图片
            ownSpec: JSON.stringify(obj) // 特有规格参数
          };
        });
      Object.assign(goodsParams, {
        cid1,
        cid2,
        cid3, // 商品分类
        skus // sku列表
      });
      goodsParams.spuDetail.genericSpec = JSON.stringify(specs);
      goodsParams.spuDetail.specialSpec = JSON.stringify(specTemplate);


      // console.log(JSON.stringify(goodsParams))
      this.$http({
        method: this.isEdit ? "put" : "post",
        url: "goodss/save",
        data: goodsParams
      })
        .then(() => {
          // 成功，关闭窗口
          this.$emit("closeForm");
          // 提示成功
          this.$message.success("保存成功了");
        })
        .catch(() => {
          this.$message.error("保存失败！");
        });
    }
  },
  watch: {
    oldGoods: {
      deep: true,
      handler(val) {
        if (!this.isEdit) {
          Object.assign(this.goods, {
            categories: null, // 商品分类信息
            brandId: 0, // 品牌id信息
            title: "", // 标题
            subTitle: "", // 子标题
            spuDetail: {
              packingList: "", // 包装列表
              afterService: "", // 售后服务
              description: "" // 商品描述
            }
          });
          this.specs = [];
          this.specialSpecs = [];
        } else {
          this.goods = Object.deepCopy(val);

         // 先得到分类名称 bug!!!!
         window.setTimeout(()=>{
               const names = val.categoryName.split("/");
              // 组织商品分类数据
              this.goods.categories = [
                { id: val.cid1, name: names[0] },
                { id: val.cid2, name: names[1] },
                { id: val.cid3, name: names[2] }
              ];
         },45)
          

          // 将skus处理成map
          const skuMap = new Map();
          this.goods.skus.forEach(s => {
            skuMap.set(s.indexes, s);
          });
          this.goods.skus = skuMap;
        }
      }
    },
    "goods.categories": {
      deep: true,
      handler(val) {
        // 判断商品分类是否存在，存在才查询
        if (val && val.length > 0) {
          // 根据分类查询品牌
          this.$http
            .get("/brand/getBrandInfoByCategoryId",{
              params:{
                cid:this.goods.categories[2].id
              }
            } )
            .then((resp) => {
              this.brandOptions = resp.data.data;
            });
          // 根据分类查询规格参数
          this.$http
            .get("/specparam/groups",{
                params:{
                  cid:this.goods.categories[2].id
                }
            } )
            .then((resp) => {
              let specs = [];
              let template = [];
              if (this.isEdit){
                specs = JSON.parse(this.goods.spuDetail.genericSpec);
                template = JSON.parse(this.goods.spuDetail.specialSpec);
              }
              // 对特有规格进行筛选
              const arr1 = [];
              const arr2 = [];
              resp.data.data.forEach(({id, name,generic, numeric, unit }) => {
                if(generic){
                  const o = { id, name, numeric, unit};
                  if(this.isEdit){
                    o.v = specs[id];
                  }
                  arr1.push(o)
                }else{
                  const o = {id, name, options:[]};
                  if(this.isEdit){
                    o.options = template[id];
                  }
                  arr2.push(o)
                }
              });
              this.specs = arr1;// 通用规格
              this.specialSpecs = arr2;// 特有规格
            });
        }
      }
    }
  },
  computed: {
    skus() {
      // 过滤掉用户没有填写数据的规格参数
      const arr = this.specialSpecs.filter(s => s.options.length > 0);
      // 通过reduce进行累加笛卡尔积
      return arr.reduce(
        (last, spec, index) => {
          const result = [];
          last.forEach(o => {
            spec.options.forEach((option, i) => {
              const obj = JSON.parse(JSON.stringify(o));
              obj[spec.name] = {v:option, id:spec.id};
              obj.indexes = (obj.indexes || '') + '_' +  i
              if (index === arr.length - 1) {
                obj.indexes = obj.indexes.substring(1);
                // 如果发现是最后一组，则添加价格、库存等字段
                Object.assign(obj, {
                  price: 0,
                  stock: 0,
                  enable: false,
                  images: []
                });
                if (this.isEdit) {
                  // 如果是编辑，则回填sku信息
                  const sku = this.goods.skus.get(obj.indexes);
                  if (sku != null) {
                    const { price, stock, enable, images } = sku;
                    Object.assign(obj, {
                      price: this.$format(price),
                      stock,
                      enable,
                      images: images ? images.split(",") : [],
                    });
                  }
                }
              }
              result.push(obj);
            });
          });
          return result;
        },
        [{}]
      );
    },
    headers() {
      if (this.skus.length <= 0) {
        return [];
      }
      const headers = [];
      Object.keys(this.skus[0]).forEach(k => {
        let value = k;
        if (k === "price") {
          // enable，表头要翻译成“价格”
          k = "价格";
        } else if (k === "stock") {
          // enable，表头要翻译成“库存”
          k = "库存";
        } else if (k === "enable") {
          // enable，表头要翻译成“是否启用”
          k = "是否启用";
        } else if (k === "images" || k === 'indexes') {
          // 图片和索引不在表格中展示
          return;
        }
        headers.push({
          text: k,
          align: "center",
          sortable: false,
          value
        });
      });
      return headers;
    }
  }
};
</script>

<style scoped>
</style>

```

#### 

#### mingrui-shop-service-api-xxx

##### GoodsService

```java
@ApiOperation(value = "通过spuId查询spudetail信息")//spudetail是基本信息表
@GetMapping(value = "goods/getSpuDetailBySpuId")
Result<SpuDetailEntity> getSpuDetailBySpuId(Integer spuId);

@ApiOperation(value = "通过spuId查询sku信息")
@GetMapping(value = "/goods/getSkusBySpuId")
Result<List<SkuDTO>> getSkusBySpuId(Integer spuId);
```



#### mingrui-shop-service-xxx

修改SkuMapper，添加一个联查的sql语句

```java
package com.baidu.shop.mapper;

import com.baidu.shop.dto.SkuDTO;
import com.baidu.shop.entity.SkuEntity;
import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.common.Mapper;
import tk.mybatis.mapper.common.special.InsertListMapper;

import java.util.List;

public interface SkuMapper extends Mapper<SkuEntity>, InsertListMapper<SkuEntity> {
    @Select(value = "select k.*,t.stock from tb_sku k, tb_stock t where k.id=t.sku_id and k.spu_id=#{spuId}")
    List<SkuDTO> getSkusAndStockBySpuId(Integer spuId);
}
```



#### GoodsServiceImpl

```java
@Override
public Result<List<SkuDTO>> getSkusBySpuId(Integer spuId) {
    List<SkuDTO> list= skuMapper.getSkusAndStockBySpuId(spuId);
    return this.setResultSuccess(list);
}

@Override
public Result<SpuDetailEntity> getSpuDetailBySpuId(Integer spuId) {
    //查询基本信息
    SpuDetailEntity spuDetailEntity = spuDetailMapper.selectByPrimaryKey(spuId);

    return this.setResultSuccess(spuDetailEntity);
}
```



## 修改(入库)

新增已经改过

```vue
	this.$http({
        method: this.isEdit ? "put" : "post",
        url: "goodss/save",
        data: goodsParams
      })
```



### mingrui-shop-service-api-xxx

#### GoodsService

```java
    @ApiOperation(value = "修改商品")
    @PutMapping(value = "/goodss/save")
    Result<JsonObject> editGoods(@Validated({MingruiOperation.Update.class}) @RequestBody SpuDTO spuDTO);
```



### mingrui-shop-service-xxx

#### 修改SkuMapper

多继承一个删除集合的操作数据库方法

```java
import com.baidu.shop.dto.SkuDTO;
import com.baidu.shop.entity.SkuEntity;
import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.additional.idlist.DeleteByIdListMapper;
import tk.mybatis.mapper.common.Mapper;
import tk.mybatis.mapper.common.special.InsertListMapper;

import java.util.List;

public interface SkuMapper extends Mapper<SkuEntity>, InsertListMapper<SkuEntity>, DeleteByIdListMapper<SkuEntity,Long> {
    @Select(value = "select k.*,t.stock from tb_sku k, tb_stock t where k.id=t.sku_id and k.spu_id=#{spuId}")
    List<SkuDTO> getSkusAndStockBySpuId(Integer spuId);
}
```

#### 修改StockMapper

多继承一个删除集合的操作数据库方法

```java
import com.baidu.shop.entity.StockEntity;
import tk.mybatis.mapper.additional.idlist.DeleteByIdListMapper;
import tk.mybatis.mapper.common.Mapper;

public interface StockMapper extends Mapper<StockEntity>, DeleteByIdListMapper<StockEntity,Long> {
}
```

#### GoodsServiceImpl

思路：

spu表和spuDetail可以直接修改

由于sku和spu是多对一，sku和stock是一对多

需要先删除sku表的数据和stock表的数据

```java
@Override
@Transactional
public Result<JsonObject> editGoods(SpuDTO spuDTO) {
    final Date date = new Date();
    //修改spu
    SpuEntity spuEntity = BaiduBeanUtil.copyProperties(spuDTO,SpuEntity.class);
    spuEntity.setLastUpdateTime(date);
    spuMapper.updateByPrimaryKey(spuEntity);
    //修改spuDetail
    spuDetailMapper.updateByPrimaryKey(BaiduBeanUtil.copyProperties(spuDTO.getSpuDetail(), SpuDetailEntity.class));
    //修改sku 和 stock，sku和spu是多对一，sku和stock是一对多
    //遍历取出每个sku
    Example example = new Example(SkuEntity.class);
    example.createCriteria().andEqualTo("spuId",spuEntity.getId());
    List<SkuEntity> skuEntities = skuMapper.selectByExample(example);
    //得到skuId集合
    List<Long> skuIdArr = skuEntities.stream().map(skuEntity -> skuEntity.getId()).collect(Collectors.toList());
    skuMapper.deleteByIdList(skuIdArr);//通过skuId集合删除sku信息
    stockMapper.deleteByIdList(skuIdArr);//通过skuId集合删除stock信息
    //新增
    this.saveSkusAndStockInfo(spuDTO,spuEntity.getId(),date);
    return this.setResultSuccess();
}
```



封装新增sku和stock方法

```java
//封装新增sku和stock方法
private void saveSkusAndStockInfo(SpuDTO spuDTO,Integer spuId,Date date){
    List<SkuDTO> skus = spuDTO.getSkus();
    skus.forEach(skuDTO -> {
        SkuEntity skuEntity = BaiduBeanUtil.copyProperties(skuDTO, SkuEntity.class);
        skuEntity.setSpuId(spuId);
        skuEntity.setCreateTime(date);
        skuEntity.setLastUpdateTime(date);
        skuMapper.insertSelective(skuEntity);

        //新增stock
        StockEntity stockEntity = new StockEntity();
        stockEntity.setSkuId(skuEntity.getId());
        stockEntity.setStock(skuDTO.getStock());
        stockMapper.insertSelective(stockEntity);
    });
}
```



封装删除sku，stock信息的方法

```java
//封装删除sku，stock信息的方法
private void deleteSkusAndStock(Integer spuId){
    Example example = new Example(SkuEntity.class);
    example.createCriteria().andEqualTo("spuId",spuId);
    List<SkuEntity> skuEntities = skuMapper.selectByExample(example);
    //得到skuId集合
    List<Long> skuIdArr = skuEntities.stream().map(skuEntity -> skuEntity.getId()).collect(Collectors.toList());
    skuMapper.deleteByIdList(skuIdArr);//通过skuId集合删除sku信息
    stockMapper.deleteByIdList(skuIdArr);//通过skuId集合删除stock信息
}
```



## 删除

###  Goods.vue

```vue
deleteItem(id) {
        this.$message.confirm('此操作将永久删除该商品, 是否继续?')
          .then(() => {
            // 发起删除请求
            this.$http.delete("/goods/deleteGoods?spuId=" + id)
              .then(() => {
                // 删除成功，重新加载数据
                this.getDataFromApi();
                this.$message.info('删除成功!');
              })
          })
          .catch(() => {
            this.$message.info('已取消删除');
          });

      },
```

###  mingrui-shop-service-api-xxx

####  GoodsService

```java
    @ApiOperation(value = "删除商品")
    @DeleteMapping(value = "/goods/deleteGoods")
    Result<JsonObject> deleteGoods(Integer spuId);
```



### mingrui-shop-service-xxx

####  GoodsServiceImpl

spu和spuDetail表可以直接根据spuID删除

sku和stock需要先获取id查再删

```java
@Override
@Transactional
public Result<JsonObject> deleteGoods(Integer spuId) {
    //删除spu
    spuMapper.deleteByPrimaryKey(spuId);
    //删除spuDetail
    spuDetailMapper.deleteByPrimaryKey(spuId);
    //删除sku 和 stock
    //通过spuId查询sku信息
    this.deleteSkusAndStock(spuId);
    return this.setResultSuccess();
}
```



## 上下架点击

### Goods.vue

line:51   52

```
<v-btn icon small v-if="props.item.saleable" @click="downOrUp(props.item)">下架</v-btn>
<v-btn icon v-else @click="downOrUp(props.item)">上架</v-btn>
```

单机触发事件方法

可以传id和saleable的值去修改上下架的状态

也可以传对象去修改上下架的状态

```vue
downOrUp(spuList){
        // spuList.saleable=spuList.saleable?0:1;  // 传id和saleable的值去修改上下架的状态
        this.$http({
          method: "put",
          url: "/goods/downOrUp",
          data: spuList
        })
        .then(resp=>{
          //刷新页面
          this.getDataFromApi();
          this.$message.success(resp.data.message)
        }).catch(error=>console.log(error))
      }
```



### service

```java
@ApiOperation(value = "上下架")
@PutMapping(value = "/goods/downOrUp")
Result<JsonObject> upOrDown(@Validated(MingruiOperation.Update.class) @RequestBody SpuDTO spuDTO);
```



### serviceImpl

```java
@Override
    @Transactional
    public Result<JsonObject> upOrDown(SpuDTO spuDTO) {
        /*如果只传id和saleable,且前台修改上下架的值
    spuMapper.updateByPrimaryKeySelective(
        BaiduBeanUtil.copyProperties(spuDTO,SpuEntity.class));*/
        
        String suc="";
        SpuEntity spuEntity = BaiduBeanUtil.copyProperties(spuDTO, SpuEntity.class);
        if (ObjectUtil.isNull(spuEntity.getSaleable()) && spuEntity.getSaleable()>1) return this.setResultError("失败");
        if (spuEntity.getSaleable()==1){
            spuEntity.setSaleable(0);
            suc="已下架";
        }else{
            spuEntity.setSaleable(1);
            suc="已上架";
        }
        spuMapper.updateByPrimaryKeySelective(spuEntity);
        return this.setResultSuccess(suc);
    }
```

……